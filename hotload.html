[module]
id = ch.suedhang.apps.honos
name = HoNOS
short_description = Health of the nation outcomes scales (HoNOS).
version = 1.0
type = patient

[description]
Gesundheit und soziale Funktionsf√§higkeit, 12 Items.

[developer]
first_name = Beat
last_name = Ottiger
github_user = ottigerb
email = beat@optinomic.com
company = Optinomic Gmbh
phone = +41 (0)44 508 26 76
website = http://www.optinomic.com/

[template scores_table 6 6]

<head>
    <meta content="Optinomic GmbH" name="author">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui" name="viewport">
</head>
<div id="optinomic_app">
<app-optinomic title="HoNOS" subtitle="Health of the Nations Outcome Scale">
    <app-honos></app-honos>
</app-optinomic>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuex@2.x/dist/vuex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.62/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.62/vfs_fonts.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.0.13/webcomponents-lite.js"></script><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/polymer/polymer.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/iron-flex-layout/iron-flex-layout.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/iron-flex-layout/iron-flex-layout-classes.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/iron-resizable-behavior/iron-resizable-behavior.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/iron-pages/iron-pages.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/paper-icon-button/paper-icon-button.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/paper-checkbox/paper-checkbox.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/paper-tabs/paper-tabs.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/paper-tooltip/paper-tooltip.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/g-r-i-d/g-r-i-d.html" rel="import"><link href="https://cdn.rawgit.com/Optinomic/polymer-cdn/optinomic-0.1.36/lib/optinomic-clinic-sample-selector/optinomic-clinic-sample-selector.html" rel="import"><dom-module id="optinomic-chart-profile"><template><style include="iron-flex iron-flex-alignment">:host{display:block;--grafic-width:480px;--grafic-height:50px;--grafic-margin-left:0;--grafic-margin-right:0;--grafic-top-space:0;--grafic-text-visibility:hidden;--item-height:50px}div.relative{position:relative;width:100%;height:var(--grafic-height)}div.absolute_left{position:absolute;top:var(--grafic-top-space);left:0;width:var(--grafic-margin-left);height:var(--grafic-height);text-align:right}div.legend_left{width:var(--grafic-margin-left)!important;min-width:var(--grafic-margin-left)!important;text-align:right;margin-bottom:8px!important}div.legend_right{width:var(--grafic-margin-right)!important;min-width:var(--grafic-margin-right)!important}div.legend_info{width:22px}div.absolute_left_mobile{position:absolute;top:var(--grafic-top-space);left:6px;width:var(--grafic-width);height:var(--grafic-height)}div.absolute_right{position:absolute;top:var(--grafic-top-space);right:0;width:var(--grafic-margin-right);height:var(--grafic-height);visibility:var(--grafic-text-visibility);text-align:left}div.absolute_center{position:absolute;top:0;left:var(--grafic-margin-left);width:var(--grafic-size);height:var(--grafic-height)}div.center{margin-left:var(--grafic-margin-left);margin-right:var(--grafic-margin-right);width:var(--grafic-size)}div.vertical_grid_every_x{position:absolute;top:0;height:20px;margin-left:-3px}div.description_item{padding-left:6px;padding-right:6px;height:var(--item-height);overflow:hidden}.legend_left_text{padding-left:6px;padding-right:7px;text-align:right;color:#9e9e9e!important;font-size:11.5px;font-weight:400;letter-spacing:.005em}.description_item_title{font-size:11.5px;font-weight:400;letter-spacing:.005em;color:#212121}.description_item_text{font-size:11.5px;font-weight:400;letter-spacing:.005em;color:#616161}.caption{font-size:10.6px;letter-spacing:.020em;line-height:70%!important;color:#757575}.grid-border-top{border-top-color:#e0e0e0;border-top-style:solid;border-top-width:1px}.fade_in{-webkit-animation:fadein 1s;-moz-animation:fadein 1s;-ms-animation:fadein 1s;-o-animation:fadein 1s;animation:fadein 1s}.config_page{padding-top:12px;padding-bottom:24px;min-height:140px;border-top-color:var(--paper-grey-100);border-top-style:solid;border-top-width:1px;margin-top:-1px}.item{display:block;padding:8px 16px;margin-right:24px;background-color:var(--paper-grey-50);min-height:52px}@keyframes fadein{from{opacity:0}to{opacity:1}}@-moz-keyframes fadein{from{opacity:0}to{opacity:1}}@-webkit-keyframes fadein{from{opacity:0}to{opacity:1}}@-ms-keyframes fadein{from{opacity:0}to{opacity:1}}@-o-keyframes fadein{from{opacity:0}to{opacity:1}}paper-checkbox.styled{margin-right:12px;align-self:center;color:red!important;--paper-checkbox-checked-color:var(--paper-grey-500);--paper-checkbox-checked-ink-color:var(--paper-grey-500);--paper-checkbox-unchecked-color:var(--paper-grey-900);--paper-checkbox-unchecked-ink-color:var(--paper-grey-900);--paper-checkbox-label-color:var(--paper-grey-900);--paper-checkbox-label-spacing:0;--paper-checkbox-margin:8px 16px 8px 0;--paper-checkbox-vertical-align:top}paper-checkbox .subtitle{display:block;font-size:.8em;margin-top:2px}paper-tabs{font-family:Roboto,Noto,sans-serif;-webkit-font-smoothing:antialiased;width:100%;margin-bottom:1px;color:var(--paper-grey-700);--paper-tabs-selection-bar-color:var(--paper-grey-500)}paper-tab{--paper-tab-ink:var(--paper-indigo-500)}paper-tooltip.left{--paper-tooltip-opacity:1;--paper-tooltip:{width:var(--grafic-margin-left);font-size:14px;margin-bottom:-12px!important};}paper-tooltip.right{--paper-tooltip-opacity:1;--paper-tooltip:{width:var(--grafic-margin-right);font-size:14px;margin-bottom:-12px!important};}iron-swipeable-pages>*{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}#grid_clinic_sample .item:last-of-type{max-width:none;width:calc(100% - 4px)}</style><span style="height:6px">&nbsp;</span><template is="dom-if" if="[[d.norm_sample_defined]]"><template is="dom-if" if="[[d.wide]]"><div class="flex horizontal layout"><div class="legend_left"><span class="legend_left_text">[[t.norm_sample]]</span></div><div class="flex"><span class="description_item_title">[[d.norm_sample]]</span></div></div></template><template is="dom-if" if="[[!d.wide]]"><p class="description_item_title"><span style="color:#9e9e9e">[[t.norm_sample]]: </span>[[d.norm_sample]]</p></template></template><template is="dom-if" if="[[cs.available]]"><template is="dom-if" if="[[d.wide]]"><div class="flex horizontal layout"><div class="legend_left"><span class="legend_left_text">[[t.clinic_sample]]</span></div><div class="flex"><span class="description_item_title">[[cs.name]]</span></div></div></template><template is="dom-if" if="[[!d.wide]]"><p class="description_item_title"><span style="color:#9e9e9e">[[t.clinic_sample]]: </span>[[cs.name]]</p></template></template><template is="dom-if" if="[[d.show_ranges_overview]]"><template is="dom-if" if="[[ranges]]"><template is="dom-if" if="[[d.wide]]"><div class="flex horizontal layout"><div class="legend_left"><span class="legend_left_text">[[t.ranges]]</span></div><div class="flex"><span class="description_item_title"><template is="dom-repeat" as="range" items="{{ranges}}"><span>{{range.text}} <span style="color:#9e9e9e">({{range.from_to}})</span><template is="dom-if" if="{{!range.last}}">,&nbsp;</template></span></template></span></div></div></template><template is="dom-if" if="[[!d.wide]]"><p class="description_item_title"><span style="color:#9e9e9e">[[t.ranges]]:</span><template is="dom-repeat" as="range" items="{{ranges}}"><span>{{range.text}} <span style="color:#9e9e9e">({{range.from_to}})</span><template is="dom-if" if="{{!range.last}}">,&nbsp;</template></span></template></p></template></template></template><template is="dom-if" if="[[start]]"><template is="dom-if" if="[[d.wide]]"><div class="flex horizontal layout"><div class="legend_left"><p class="legend_left_text" style$="text-align:right; color:[[start.left_color]] !important">[[start.left_title]]</p></div><div class="flex"><p class="description_item_title">[[start.left_text]]</p></div><div class="flex"><p class="description_item_title" style="text-align:right">[[start.right_text]]</p></div><div class="fade_in legend_right"><p class="legend_left_text" style$="text-align:left; color:[[start.right_color]] !important">[[start.right_title]]</p></div></div></template><template is="dom-if" if="[[!d.wide]]"><div class="fade_in center"><div class="flex horizontal layout"><div class="flex"><p class="description_item_title"><span style$="color:[[start.left_color]]">[[start.left_title]]</span><br>[[start.left_text]]</p></div><div class="flex"><p class="description_item_title" style="text-align:right"><span style$="color:[[start.right_color]]">[[start.right_title]]</span><br>[[start.right_text]]</p></div></div></div></template></template><div class="fade_in relative" id="svg_grafic"><template is="dom-if" if="[[draw_chart]]"><div class="fade_in absolute_center"><template is="dom-repeat" as="g" items="[[verticalGrid]]"><template is="dom-if" if="[[d.topnumber_hide_first_last]]"><template is="dom-if" if="[[!g.first_last]]"><div class="vertical_grid_every_x" style$="left:[[g.x]]px"><p class="flex caption caption" style="color:#000">[[g.value]]</p></div></template></template><template is="dom-if" if="[[!d.topnumber_hide_first_last]]"><template is="dom-if" if="[[!g.last]]"><div class="vertical_grid_every_x" style$="left:[[g.x]]px"><p class="flex caption caption" style="color:#000">[[g.value]]</p></div></template><template is="dom-if" if="[[g.last]]"><div class="vertical_grid_every_x" style$="left:[[g.x]]px; text-align:right;"><p class="flex caption caption" style="color:#000">[[g.value]]</p></div></template></template></template></div></template><template is="dom-if" if="[[draw_chart]]" restamp="true"><div class="absolute_center"><template is="dom-if" if="[[scales_set]]"><svg-container height$="[[d.grafic_height]]px" id="svg_container" view-box$="0 0 100 [[d.grafic_height]]" width="[[d.grafic_wight]]px"><svg-component is="g" id="horizontalGrid"><template is="dom-repeat" as="scale" items="[[scales]]"><svg-component is="line" stroke-width="0.5" stroke$="[[d.color_grid]]" x2$="[[d.grafic_width]]" y1$="[[scale.bottomline]]" y2$="[[scale.bottomline]]" x1="0"></svg-component><template is="dom-if" if="[[scale.first]]"><svg-component is="line" stroke-width="0.5" stroke$="[[d.color_grid]]" x2$="[[d.grafic_width]]" y1$="[[scale.topline]]" y2$="[[scale.topline]]" x1="0"></svg-component></template><template is="dom-if" if="[[d.show_baseline]]"><svg-component is="line" stroke-width="0.5" stroke$="[[d.color_grid_baseline]]" x2$="[[d.grafic_width]]" y1$="[[scale.baseline]]" y2$="[[scale.baseline]]" x1="0"></svg-component></template></template></svg-component><svg-component is="g" id="verticalGrid"><template is="dom-repeat" as="grid" items="[[verticalGrid]]"><template is="dom-if" if="[[grid.zero]]"><svg-component is="line" stroke-width="3" stroke$="[[d.color_grid]]" x2$="[[grid.x]]" y1$="[[grid.y1]]" y2$="[[grid.y2]]" x1$="[[grid.x]]"></svg-component></template><template is="dom-if" if="[[!grid.zero]]"><svg-component is="line" stroke-width="0.5" stroke$="[[d.color_grid]]" x2$="[[grid.x]]" y1$="[[grid.y1]]" y2$="[[grid.y2]]" x1$="[[grid.x]]"></svg-component></template></template></svg-component></svg-container></template></div></template><template is="dom-if" if="[[d.wide]]"><template is="dom-if" if="[[d.item_text_left_show]]"><div class="absolute_left"><template is="dom-repeat" as="s" items="[[scales]]" id="left_beschriftung"><div class="horizontal layout description_item fade_in"><div class="flex self-center"><div class="flex horizontal layout"><div class="flex"><p class="description_item_title right" id$="[[s.id_left_text]]">[[s.left_title]]<template is="dom-if" if="[[d.show_scale_text]]"><template is="dom-if" if="[[s.left_title]]"><template is="dom-if" if="[[s.left_text]]"><span class="description_item_title" style="margin-left:-2px">: &nbsp;</span></template></template><span class="description_item_text">[[s.left_text]]</span></template><template is="dom-if" if="[[!d.show_scale_text]]"><paper-tooltip class="left" position="top">[[s.left_text]]</paper-tooltip></template></p></div></div></div></div></template></div></template><template is="dom-if" if="[[d.item_text_right_show]]"><div class="absolute_right"><template is="dom-repeat" as="s" items="[[scales]]" id="right_beschriftung"><div class="horizontal layout description_item fade_in"><div class="flex self-center"><div class="flex horizontal layout self-center"><div class="flex"><p class="description_item_title" id$="[[s.id_right_text]]">[[s.right_title]]<template is="dom-if" if="[[d.show_scale_text]]"><template is="dom-if" if="[[s.right_title]]"><template is="dom-if" if="[[s.right_text]]"><span class="description_item_title" style="margin-left:-2px">: &nbsp;</span></template></template><span class="description_item_text">[[s.right_text]]</span></template><template is="dom-if" if="[[!d.show_scale_text]]"><paper-tooltip class="right" position="top">[[s.right_text]]</paper-tooltip></template></p></div></div></div></div></template></div></template></template><template is="dom-if" if="[[!d.wide]]"><div class="absolute_left_mobile"><template is="dom-repeat" as="s" items="[[scales]]" id="right_beschriftung"><div class="horizontal layout description_item fade_in"><div class="flex self-center"><div class="flex horizontal layout"><p class="flex description_item_title right">[[s.left_title]]</p></div></div></div></template></div></template><template is="dom-if" if="[[draw_chart]]" restamp="true"><template is="dom-repeat" as="range" items="{{ranges}}"><template is="dom-if" if="{{range.show}}"><div class="fade_in absolute_center"><svg-container height$="[[d.grafic_height]]px" id="svg_container_ranges" view-box$="0 0 100 [[d.grafic_height]]" width="[[d.grafic_wight]]px"><svg-component is="g" class="fade"><svg-component is="rect" stroke-width="none" fill$="[[range.rgb]]" height$="[[range.height]]" width$="[[range.width]]" x$="[[range.x]]" y$="[[range.y]]"></svg-component><svg-component is="line" stroke-width="1" stroke$="[[range.line_color]]" x2$="[[range.line_x_left]]" y1$="[[range.line_y1]]" y2$="[[range.line_y2]]" x1$="[[range.line_x_left]]"></svg-component><svg-component is="line" stroke-width="1" stroke$="[[range.line_color]]" x2$="[[range.line_x_right]]" y1$="[[range.line_y1]]" y2$="[[range.line_y2]]" x1$="[[range.line_x_right]]"></svg-component></svg-component></svg-container></div></template></template></template><template is="dom-if" if="[[draw_chart]]" restamp="true"><template is="dom-repeat" as="cs" items="{{_clinic_sample_profiles}}"><template is="dom-if" if="{{cs.show}}"><div class="fade_in absolute_center"><svg-container height$="[[d.grafic_height]]px" id="svg_container_profiles" view-box$="0 0 100 [[d.grafic_height]]" width="[[d.grafic_wight]]px"><svg-component is="g" id="csProfile" class="fade"><svg-component is="polygon" stroke-width="0" points$="[[cs.points_str]]" fill$="[[cs.color_profile]]"></svg-component><svg-component is="polyline" stroke-width="1" stroke$="[[cs.color_line]]" fill="none" points$="[[cs.points_str_min]]"></svg-component><svg-component is="polyline" stroke-width="1" stroke$="[[cs.color_line]]" fill="none" points$="[[cs.points_str_max]]"></svg-component><svg-component is="polyline" stroke-width="2" stroke$="[[cs.color_line_mean]]" fill="none" points$="[[cs.points_str_mean]]"></svg-component></svg-component></svg-container></div></template></template></template><template is="dom-if" if="[[draw_chart]]" restamp="true"><template is="dom-repeat" as="score" items="{{_score_profiles}}" id="all_repeat"><template is="dom-if" if="[[!score.dropout_is]]"><template is="dom-if" if="{{score.show}}"><div class="fade_in absolute_center"><svg-container height$="[[d.grafic_height]]px" id="svg_container_profiles" view-box$="0 0 100 [[d.grafic_height]]" width="[[d.grafic_wight]]px"><svg-component is="g" id="scoreProfile" class="fade"><template is="dom-if" if="{{d.show_score_profile_line}}"><svg-component is="polyline" stroke-width="5" stroke$="[[score.color]]" fill="none" points$="[[score.points_str]]"></svg-component></template><template is="dom-if" if="{{d.show_score_vertical_line}}"><template is="dom-repeat" as="line" items="[[score.lines]]"><svg-component is="line" stroke-width="5" stroke$="[[score.color_line]]" x2$="[[line.x]]" y1$="[[line.y1]]" y2$="[[line.y2]]" x1$="[[line.x]]"></svg-component></template></template><template is="dom-if" if="{{d.show_score_circles}}"><template is="dom-repeat" as="point" items="[[score.points]]"><svg-component is="circle" stroke-width="2" stroke$="[[point.stroke]]" cx$="[[point.x]]" cy$="[[point.y]]" fill$="[[point.fill]]" r="6"></svg-component></template></template></svg-component></svg-container></div></template></template></template></template></div><div class=""><template is="dom-if" if="[[!d.show_settings_block]]" restamp="true"><div class="flex horizontal layout" style="margin-top:6px"><div class="legend_left" style="margin-top:2px"><template is="dom-if" if="[[d.allow_toggle_settings_block]]" restamp="true"><paper-icon-button icon="settings" on-tap="__toggleSettingsBlock" style="color:#e0e0e0"></paper-icon-button></template></div><div class="flex"><g-r-i-d gutter="4" row-height="" shown="{{animate_grid_0}}" min-column-width="150"><template is="dom-if" if="[[draw_chart]]" restamp="true"><template is="dom-repeat" as="score" items="{{_score_profiles}}"><div class="flex horizontal layout" style="padding:0;margin:0;cursor:crosshair" on-tap="__toggleScore"><div class="legend_info"><template is="dom-if" if="[[score.show]]"><p style$="font-size:64px; height:8px;  margin-top:-18px; padding:0; color:[[score.color]] ">-</p></template></div><div class="flex" style="padding:0;margin:0"><p class="description_item_title">[[score.title]]<template is="dom-if" if="[[score.dropout_is]]">| [[score.dropout_reason]]</template><span style="color:#9e9e9e"><br>[[score.date]]</span><template is="dom-if" if="[[score.dropout_is]]">| <span style="color:#f44336">Dropout</span></template>&nbsp;</p></div></div></template></template></g-r-i-d></div></div></template><div hidden="[[!d.show_settings_block]]"><div class="flex horizontal layout"><div hidden="[[!d.allow_toggle_settings_block]]"><div class="fade_in"><paper-icon-button icon="close" on-tap="__toggleSettingsBlock" style="color:#e0e0e0;margin-top:8px"></paper-icon-button></div></div><div class="flex"><paper-tabs autoselect autoselect-delay="100" fit-container on-iron-select="__tabChanged" scrollable selected="{{d.tab_selected}}"><paper-tab>{{t.measurements}}</paper-tab><paper-tab>{{t.clinic_sample}}</paper-tab><paper-tab>{{t.ranges}}</paper-tab></paper-tabs></div></div><iron-pages selected="{{d.tab_selected}}"><div class="config_page"><template is="dom-if" if="[[d.show_settings_block]]" restamp="true"><g-r-i-d gutter="4" row-height="" shown="{{animate_grid_0}}" min-column-width="250"><template is="dom-repeat" as="score" items="{{_score_profiles}}"><template is="dom-if" if="[[score.dropout_is]]"><div class="item" style="border:1px solid #f44336;background-color:#ffebee"><paper-checkbox checked="{{score.show}}" class="styled" disabled="[[score.dropout_is]]"><span>[[score.title]] | <span style="color:#f44336">Dropout</span></span> <span class="subtitle">[[score.date]] | [[score.dropout_reason]]</span></paper-checkbox></div></template><template is="dom-if" if="[[!score.dropout_is]]"><div class="item" style$="border:1px solid {{score.color}}; background-color:{{score.color_rgb}};"><paper-checkbox checked="{{score.show}}" class="styled"><span>[[score.title]]</span> <span class="subtitle">[[score.date]]</span></paper-checkbox></div></template></template></g-r-i-d></template></div><div class="fade_in config_page"><g-r-i-d gutter="4" row-height="" shown="{{animate_grid_1}}" colums="1" id="grid_clinic_sample"><template is="dom-if" if="{{!clinic_samples.empty}}"><template is="dom-repeat" as="cs" items="{{_clinic_sample_profiles}}"><div class="item" style$="border: 1px solid {{cs.color}}; background-color: {{cs.color_bg}}; width:100%;"><paper-checkbox checked="{{cs.show}}" class="styled"><span>{{cs.name}}</span></paper-checkbox></div></template><div class="item" style="border:1px solid #000;width:100%"><optinomic-clinic-sample-selector clinic_sample="[[clinic_samples]]" data_dive="[[clinic_sample_dive]]" data_dive_path="statistics" on-clinic-sample-changed="__csChanged" return_data="{{clinic_sample_data}}"></optinomic-clinic-sample-selector></div></template><template is="dom-if" if="{{clinic_samples.empty}}"><div class="item" style="border:1px solid #263238;background-color:#eceff1;width:100%"><span style="color:#263238">Keine Klinichstichprobe vorhanden.</span><br><span class="subtitle">No clinic samples availabe.</span></div></template></g-r-i-d></div><div class="fade_in config_page"><template is="dom-if" if="[[d.show_settings_block]]" restamp="true"><g-r-i-d gutter="4" row-height="" shown="{{animate_grid_2}}" min-column-width="360"><template is="dom-if" if="{{d.ranges_available}}"><template is="dom-repeat" as="range" items="{{ranges}}"><div class="item" style$="border: 1px solid {{range.color}}; background-color: {{range.color_bg}};"><paper-checkbox checked="{{range.show}}" class="styled"><span>{{range.text}}</span> <span class="subtitle">{{range.from_to}}</span></paper-checkbox></div></template></template><template is="dom-if" if="{{!d.ranges_available}}"><div class="item" style="border:1px solid #263238;background-color:#eceff1"><span style="color:#263238">Keine Interpretation vorhanden.</span><br><span class="subtitle">No ranges availabe.</span></div></template></g-r-i-d></template></div></iron-pages></div></div></template><script>Polymer({is:"optinomic-chart-profile",behaviors:[Polymer.IronResizableBehavior],listeners:{"iron-resize":"__onIronResize"},properties:{language:{type:String,value:"de"},options:{type:Object,observer:"onInit"},start:{type:Object,observer:"onInit"},scales:{type:Object,observer:"onInit"},scores:{type:Object,observer:"onInit"},ranges:{type:Object,observer:"onInit"},clinic_samples:{type:Object,observer:"onInit"},clinic_sample_dive:{type:Array,notify:!0,observer:"onInit"},_clinic_sample_profiles:{type:Array,notify:!0}},__translate:function(given_language){var t={language:given_language};t.to="de"===given_language?"bis":"to",t.measurements="de"===given_language?"Messung":"Measurement",t.clinic_sample="de"===given_language?"Klinikstichprobe":"Clinical sample",t.norm_sample="de"===given_language?"Normstichprobe":"Norm sample",t.ranges="de"===given_language?"Interpretation":"Ranges",this.t=t},__init:function(){this.start=void 0===this.start?null:this.start,this.scales=void 0===this.scales?[]:this.scales,this.ranges=void 0===this.ranges?[]:this.ranges,this.scores=void 0===this.scores?{}:this.scores,this.clinic_samples=void 0===this.clinic_samples?{empty:!0}:this.clinic_samples;var init_dive_path=[];"dimensions"in this.clinic_samples&&this.clinic_samples.dimensions.forEach(function(dim,dimID){init_dive_path.push(dim.array.length-1)}),this.clinic_sample_dive=void 0===this.clinic_sample_dive?init_dive_path:this.clinic_sample_dive;var d=void 0===this.options?{}:this.options;d.color_grid=void 0===d.color_grid?"#795548":d.color_grid,d.topnumber_hide_first_last=void 0!==d.topnumber_hide_first_last&&d.topnumber_hide_first_last,console.log("d",d,this.scores),d.color_grid_baseline=void 0===d.color_grid_baseline?hexToRGB(d.color_grid,.4):d.color_grid_baseline,d.color_clinic_sample=void 0===d.color_clinic_sample?"#673AB7":d.color_clinic_sample,d.show_baseline=void 0!==d.show_baseline&&d.show_baseline,d.show_score_vertical_line=void 0!==d.show_score_vertical_line&&d.show_score_vertical_line,d.show_score_profile_line=void 0===d.show_score_profile_line||d.show_score_profile_line,d.show_score_circles=void 0===d.show_score_circles||d.show_score_circles,d.show_scale_text=void 0!==d.show_scale_text&&d.show_scale_text,d.show_settings_block=void 0!==d.show_settings_block&&d.show_settings_block,d.show_ranges_overview=void 0===d.show_ranges_overview||d.show_ranges_overview,d.allow_toggle_settings_block=void 0===d.allow_toggle_settings_block||d.allow_toggle_settings_block,d.item_height=void 0===d.item_height?50:d.item_height,d.item_text_left=void 0===d.item_text_left?120:d.item_text_left,d.item_text_left_show=!0,0===d.item_text_left&&(d.item_text_left_show=!1),d.item_text_right=void 0===d.item_text_right?120:d.item_text_right,d.item_text_right_show=!0,0===d.item_text_right&&(d.item_text_right_show=!1),d.item_text_left<=62?d.legend_left=62:d.legend_left=d.item_text_left,d.response_title_path=void 0===d.response_title_path?null:d.response_title_path,d.response_date_path=void 0===d.response_date_path?null:d.response_date_path,d.min=void 0===d.min?"auto":d.min,d.max=void 0===d.max?"auto":d.max,d.range_alpha=void 0===d.range_alpha?.1:d.range_alpha,d.vertical_grid_every_x=void 0===d.vertical_grid_every_x?1:d.vertical_grid_every_x,d.ranges_available=!1,this.ranges.length>0&&(d.ranges_available=!0),d.norm_sample_defined="norm_sample"in d,d.wide=!0,d.wide_breakpoint=void 0===d.wide_breakpoint?520:d.wide_breakpoint,d.grafic_top_space=20,d.grafic_width=void 0===d.grafic_width?480:d.grafic_width,d.grafic_margin_left=d.item_text_left,d.grafic_margin_right=d.item_text_right,d.grafic_text_visibility="hidden",d.grafic_height=d.item_height*this.scales.length+d.grafic_top_space+1,d.tab_selected=0,d.color_skin=void 0===d.color_skin?"default":d.color_skin,this.set("d",d)},__setScales:function(full){full=void 0===full;var d=this.get("d"),scales=this.get("scales"),scores=this.get("scores.data");__getScorePath=function(current_score,path){var data_dive=JSON.parse(JSON.stringify(current_score)),dots_count=path.split(".").length-1;if(0===dots_count)return data_dive[path];var dive=[];for(i=0;i<dots_count;i++){var n=path.indexOf("."),item=path.substring(0,n);path=path.substring(n+1,path.length),dive.push(item),i===dots_count-1&&dive.push(path)}for(i=0;i<dive.length;i++)if(data_dive=data_dive[dive[i]],i===dots_count)return data_dive},void 0!==scales&&null!==scales&&scales.forEach(function(scale,scaleID){scale.id=scaleID,scale.id_left_text=scaleID+"_left_text",scale.id_right_text=scaleID+"_right_text",scale.topline=scaleID*d.item_height+d.grafic_top_space,scale.baseline=scale.topline+d.item_height/2,scale.bottomline=scale.topline+d.item_height,scale.first=!1,0===scaleID&&(scale.first=!0),scale.last=!1,scaleID===scales.length-1&&(scale.last=!0),scale.scores=[],void 0!==scores&&null!==scores&&scores.forEach(function(score,scoreID){var score_obj={value:null,dropout_is:!1,dropout_reason:""};scale.score_path&&(score_obj.value=this.__getScorePath(score,scale.score_path)),d.response_title_path?score_obj.title=this.__getScorePath(score,d.response_title_path):score_obj.title="Unbekannt",d.response_date_path?score_obj.date=this.__getScorePath(score,d.response_date_path):score_obj.date=null,"dropout"in d&&d.dropout&&!0===this.__getScorePath(score,d.dropout)&&(score_obj.dropout_is=!0,score_obj.dropout_reason=this.__getScorePath(score,d.dropout_reason)),scale.scores.push(score_obj)})});var do_min=!1;"auto"===d.min||void 0===d.min?do_min=!0:(item_min=parseInt(d.min),this.set("d.item_min",item_min));var do_max=!1;if("auto"===d.max||void 0===d.max?do_max=!0:(item_max=parseInt(d.max),this.set("d.item_max",item_max)),do_max||do_min){var min_max=__autoMinMax(do_min,do_max,d,this.scales);this.set("d.item_min",min_max.item_min),this.set("d.item_max",min_max.item_max)}this.set("scales_set",!0),full&&(this.__setRanges(),this.__setVerticalGrid(),this.__setScoreProfiles())},__setVerticalGrid:function(){var d=this.get("d"),every=d.vertical_grid_every_x,every_counter=0;for(vGrid=[],i=d.item_min;i<d.item_max+1;i++){every_counter+=1;var grid_object={count:i-d.item_min,value:i,x:__getXPos(d.item_min,d.item_max,d.grafic_width,i),y1:d.grafic_top_space,y2:d.grafic_height-1,zero:!1,first:!1,last:!1,first_last:!1};0===i&&(grid_object.zero=!0),i-d.item_min==0&&(grid_object.first=!0),i-d.item_max==0&&(grid_object.last=!0),(grid_object.first||grid_object.last)&&(grid_object.first_last=!0),every_counter!==every&&i!==d.item_min&&i!==d.item_max&&0!==i||(vGrid.push(grid_object),every_counter=0)}this.set("verticalGrid",vGrid)},__setRanges:function(){var ranges=JSON.parse(JSON.stringify(this.get("ranges"))),d=this.get("d"),t=this.get("t");ranges.length>0&&(ranges.forEach(function(range,rangeID){range.id=rangeID,range.color_bg=hexToRGB(range.color,.1),range.rgb=hexToRGB(range.color,d.range_alpha),range.show=void 0===range.show||range.show,range.from_to="",range.start=range.range_start,range.stop=range.range_stop,-999===range.range_start?(range.start=d.item_min,range.from_to="<="):range.from_to=">"+range.start+" "+t.to+" ",999===range.range_stop?(range.stop=d.item_max,range.from_to=">="+range.start):range.from_to=range.from_to+range.stop,rangeID===ranges.length-1?range.last=!0:range.last=!1,range.start_pos=__getXPos(d.item_min,d.item_max,d.grafic_width,range.start),range.stop_pos=__getXPos(d.item_min,d.item_max,d.grafic_width,range.stop),range.width=range.stop_pos-range.start_pos,range.x=__getXPos(d.item_min,d.item_max,d.grafic_width,range.start),range.y=d.grafic_top_space,range.height=d.grafic_height-d.grafic_top_space-1,range.line_x_left=range.x+1,range.line_x_right=range.x+range.width-1,range.line_y1=d.grafic_top_space,range.line_y2=d.grafic_height-1,range.line_color=hexToRGB(range.color,2*d.range_alpha)}),this.set("ranges",ranges))},__setScoreProfiles:function(){var d=this.get("d"),ranges=this.get("ranges"),scales=this.get("scales"),my_min=d.item_min,my_max=d.item_max,my_100=d.grafic_width,scores_points=[],scores_lines=[];scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){score.value_x=__getXPos(my_min,my_max,my_100,score.value),score.value_y=scale.baseline;var my_color=getColor(scoreID,d.color_skin),score_obj={id:scoreID,title:score.title,date:formatDateCH(score.date),points:[],lines:[],points_str:"",color:my_color,color_line:hexToRGB(my_color,.8),color_rgb:hexToRGB(my_color,.1),dropout_is:score.dropout_is,dropout_reason:score.dropout_reason};"show"in score?(score_obj.show=score.show,console.error(score)):score_obj.show=!0,score.dropout_is&&(score_obj.show=!1);var points_obj={value:score.value,x:score.value_x,y:score.value_y,stroke:my_color,fill:"white"},line_obj={y1:scale.topline,y2:scale.bottomline,x:score.value_x};ranges.length>0&&ranges.forEach(function(range,rangeID){score.value_x>=range.start_pos&&score.value_x<=range.stop_pos&&(points_obj.fill=range.color)}),scores_points[scoreID]=void 0===scores_points[scoreID]?score_obj:scores_points[scoreID],scores_points[scoreID].points.push(points_obj),scores_points[scoreID].points_str=scores_points[scoreID].points_str+score.value_x+","+score.value_y+" ",scores_lines[scoreID]=void 0===scores_lines[scoreID]?score_obj:scores_lines[scoreID],scores_lines[scoreID].lines.push(line_obj)})}),this.set("_score_profiles",scores_points)},__csChanged:function(e){var d=this.get("d"),scales=this.get("scales");if(void 0!==e)if(void 0!==e.detail)var clinic_sample_name=e.detail;else clinic_sample_name="AUTO";var clinic_sample_data=this.get("clinic_sample_data"),clone_clinic_sample_profiles=JSON.parse(JSON.stringify([])),my_min=d.item_min,my_max=d.item_max,my_100=d.grafic_width,abstand=d.item_height/5,scores_points_min=[],scores_points_max=[],scores_points_mean=[];clone_clinic_sample_profiles.forEach(function(cs,csID){cs.show=!1}),scales.forEach(function(scale,scaleID){var data=clinic_sample_data[scale.clinic_sample_var];scale.clinic_sample_min=data.mean_1sd_min,scale.clinic_sample_max=data.mean_1sd_plus,scale.clinic_sample_mean=data.mean,-1===clinic_sample_name.indexOf("(N=")&&(clinic_sample_name=e.detail+" (N="+data.n+")");var points_obj_min={},points_obj_max={},points_obj_mean={};0===scaleID?(points_obj_min={value:scale.clinic_sample_min,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_min),y:scale.topline,scaleID:scaleID},points_obj_max={value:scale.clinic_sample_max,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_max),y:scale.topline,scaleID:999.5-scaleID},points_obj_mean={value:scale.clinic_sample_mean,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_mean),y:scale.topline,scaleID:scaleID}):(points_obj_min={value:scale.clinic_sample_min,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_min),y:scale.topline+abstand,scaleID:scaleID},points_obj_max={value:scale.clinic_sample_max,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_max),y:scale.topline+abstand,scaleID:999.5-scaleID},points_obj_mean={value:scale.clinic_sample_mean,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_mean),y:scale.topline+abstand,scaleID:scaleID}),scores_points_min.push(points_obj_min),scores_points_max.push(points_obj_max),scores_points_mean.push(points_obj_mean),scaleID===scales.length-1?(points_obj_min={value:scale.clinic_sample_min,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_min),y:scale.bottomline,scaleID:scaleID},points_obj_max={value:scale.clinic_sample_max,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_max),y:scale.bottomline,scaleID:999-scaleID},points_obj_mean={value:scale.clinic_sample_mean,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_mean),y:scale.bottomline,scaleID:scaleID}):(points_obj_min={value:scale.clinic_sample_min,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_min),y:scale.bottomline-abstand,scaleID:scaleID},points_obj_max={value:scale.clinic_sample_max,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_max),y:scale.bottomline-abstand,scaleID:999-scaleID},points_obj_mean={value:scale.clinic_sample_mean,x:__getXPos(my_min,my_max,my_100,scale.clinic_sample_mean),y:scale.bottomline-abstand,scaleID:scaleID}),scores_points_min.push(points_obj_min),scores_points_max.push(points_obj_max),scores_points_mean.push(points_obj_mean)}),this.set("scales",scales);var key,cs_profile={name:clinic_sample_name,show:!0,color:d.color_clinic_sample,color_bg:hexToRGB(d.color_clinic_sample,.1),color_profile:hexToRGB(d.color_clinic_sample,.3),color_line:hexToRGB(d.color_clinic_sample,.8),color_line_mean:hexToRGB("#FFFFFF",.5)};cs_profile.points_str="",cs_profile.points_str_min="",cs_profile.points_str_max="",cs_profile.points_str_mean="",scores_points_min.forEach(function(p,pID){cs_profile.points_str=cs_profile.points_str+p.x+","+p.y+" ",cs_profile.points_str_min=cs_profile.points_str_min+p.x+","+p.y+" "}),key="scaleID",(scores_points_max=scores_points_max.sort(function(a,b){var x=a[key],y=b[key];return x<y?-1:x>y?1:0})).forEach(function(p,pID){cs_profile.points_str=cs_profile.points_str+p.x+","+p.y+" ",cs_profile.points_str_max=cs_profile.points_str_max+p.x+","+p.y+" "}),scores_points_mean.forEach(function(p,pID){cs_profile.points_str_mean=cs_profile.points_str_mean+p.x+","+p.y+" "}),clone_clinic_sample_profiles.push(cs_profile),this.set("_clinic_sample_profiles",clone_clinic_sample_profiles);var cs={available:!1,name:""};clone_clinic_sample_profiles.length>0&&(cs.name=clone_clinic_sample_profiles[0].name,cs.available=!0),this.set("cs",cs)},__refreshChart:function(){var myNode=document.getElementById("svg_grafic");myNode.innerHTML="",myNode.appendChild(this.myProfiles),this.$.all_repeat.render()},__resizeGrafic:function(follow){follow=void 0===follow;var d=this.get("d");d.wide=void 0===d.wide||d.wide;var full_width=this.$.svg_grafic.offsetWidth;d.wide?(this.set("d.grafic_width",full_width-(this.d.grafic_margin_left+this.d.grafic_margin_right)),this.set("d.grafic_text_visibility","visible"),this.customStyle["--grafic-margin-left"]=this.d.grafic_margin_left+"px",this.customStyle["--grafic-margin-right"]=this.d.grafic_margin_right+"px"):(this.set("d.grafic_width",full_width),this.set("d.grafic_text_visibility","hidden"),this.customStyle["--grafic-margin-left"]="0px",this.customStyle["--grafic-margin-right"]="0px"),this.customStyle["--grafic-top-space"]=this.d.grafic_top_space+"px",this.customStyle["--item-height"]=this.d.item_height+"px",this.customStyle["--grafic-height"]=this.d.grafic_height+"px",this.customStyle["--grafic-size"]=this.d.grafic_width+"px",this.customStyle["--grafic-text-visibility"]=this.d.grafic_text_visibility,this.updateStyles(),follow&&this.__setScales(),this.__redrawChart()},__onIronResize:function(){var width=Math.floor(this.offsetWidth);void 0!==this.d&&(width<=this.d.wide_breakpoint?this.set("d.wide",!1):this.set("d.wide",!0),this.__resizeGrafic())},__tabChanged:function(){var d=this.get("d");d.animate_grid_0=!1,d.animate_grid_1=!1,d.animate_grid_2=!1,str_var="animate_grid_"+d.tab_selected,d[str_var]=!0,this.set("animate_grid_0",d.animate_grid_0),this.set("animate_grid_1",d.animate_grid_1),this.set("animate_grid_2",d.animate_grid_2)},__tabChanged:function(){var d=this.get("d");d.animate_grid_0=!1,d.animate_grid_1=!1,d.animate_grid_2=!1,str_var="animate_grid_"+d.tab_selected,d[str_var]=!0,this.set("animate_grid_0",d.animate_grid_0),this.set("animate_grid_1",d.animate_grid_1),this.set("animate_grid_2",d.animate_grid_2)},__redrawChart:function(){this.set("draw_chart",!1),this.debounce("__redrawChart",function(){setTimeout(function(){if(this.__setScales(!0),void 0!==this._clinic_sample_profiles&&void 0!==this._clinic_sample_profiles[0].name){var fake_event={detail:this._clinic_sample_profiles[0].name};this.__csChanged(fake_event)}this.set("draw_chart",!0)}.bind(this),50)},350)},__toggleSettingsBlock:function(){this.set("d.show_settings_block",!this.d.show_settings_block)},__toggleScore:function(oEvent){_score_profiles=this.get("_score_profiles");var current_score=oEvent.model.get("score");current_score.show=!current_score.show,_score_profiles[current_score.id]=current_score,this.set("_score_profiles",_score_profiles),this.__redrawChart(),console.warn("___toggleScore",current_score,_score_profiles)},onInit:function(){this.debounce("onInit",function(){this.__init()},250)},ready:function(){this.__translate(this.language)},attached:function(){this.set("draw_chart",!1)},get_parent(){return this.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE?this.parentNode.host:this.parentNode}}),getColor=function(id,color_skin){var colors=[];return"default"===(color_skin=void 0===color_skin?"default":color_skin)&&(colors.push("#3F51B5"),colors.push("#E91E63"),colors.push("#00BCD4"),colors.push("#8BC34A"),colors.push("#FFC107"),colors.push("#795548"),colors.push("#673AB7"),colors.push("#F44336"),colors.push("#03A9F4"),colors.push("#4CAF50"),colors.push("#FFEB3B"),colors.push("#FF5722"),colors.push("#2196F3"),colors.push("#9C27B0"),colors.push("#009688"),colors.push("#CDDC39"),colors.push("#FF9800"),colors.push("#607D8B")),"grey_dark_to_light"===color_skin&&(colors.push("#424242"),colors.push("#9E9E9E"),colors.push("#E0E0E0"),colors.push("#FAFAFA")),"indigo_dark_to_light"===color_skin&&(colors.push("#283593"),colors.push("#3F51B5"),colors.push("#7986CB"),colors.push("#E8EAF6")),"pink_dark_to_light"===color_skin&&(colors.push("#AD1457"),colors.push("#E91E63"),colors.push("#7986CB"),colors.push("#E8EAF6")),"indigo_grey_pink"===color_skin&&(colors.push("#1A237E"),colors.push("#212121"),colors.push("#880E4F"),colors.push("#3F51B5"),colors.push("#9E9E9E"),colors.push("#E91E63"),colors.push("#C5CAE9"),colors.push("#F5F5F5"),colors.push("#F8BBD0")),"zebra"===color_skin&&(colors.push("#212121"),colors.push("#EEEEEE")),id>colors.length-1?colors[id-Math.floor(id/colors.length)*colors.length]:colors[id]},hexToRGB=function(hex,alpha){var h="0123456789ABCDEF",r=16*h.indexOf(hex[1])+h.indexOf(hex[2]),g=16*h.indexOf(hex[3])+h.indexOf(hex[4]),b=16*h.indexOf(hex[5])+h.indexOf(hex[6]);return alpha?"rgba("+r+", "+g+", "+b+", "+alpha+")":"rgb("+r+", "+g+", "+b+")"},__autoMinMax=function(do_min,do_max,d,all_scales){return do_min&&(d.item_min=0),do_max&&(d.item_max=0),all_scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){do_min&&score.value<d.item_min&&(d.item_min=score.value),do_max&&score.value>d.item_max&&(d.item_max=score.value)})}),do_min?(d.item_min<0?(d.item_min=Math.ceil(Math.abs(d.item_min))+1,d.item_min=-1*d.item_min):d.item_min=Math.ceil(Math.abs(d.item_min))+1,d.item_min>0&&(d.item_min=0)):d.item_min=d.min,do_max?d.item_max<0?(d.item_max=Math.ceil(Math.abs(d.item_max))+1,d.item_max=-1*d.item_max):d.item_max=Math.ceil(Math.abs(d.item_max))+1:d.item_max=d.max,d},__getXPos=function(min,max,svg_width_100,current_value){var width_value=null;if(void 0!==current_value){current_value=current_value;var width_100=Math.abs(min)+Math.abs(max);width_value=svg_width_100/width_100*(current_value+Math.abs(min)),width_value_max=svg_width_100/width_100*(Math.abs(max)+Math.abs(min)),width_value>width_value_max&&(width_value=width_value_max),width_value<0&&(width_value=0)}return width_value},formatDateCH=function(date_string){if(void 0!==date_string&&null!==date_string){var year=parseInt(date_string.substring(0,4)),month=parseInt(date_string.substring(5,7));return parseInt(date_string.substring(8,10))+"."+month+"."+year}return null};</script></dom-module><dom-module id="svg-container"><template><svg id="svg" preserveAspectRatio="xMinYMin meet" version="1.1" width="100%" xmlns="http://www.w3.org/2000/svg"></svg><content select="svg-component"></content></template><script>Polymer({is:"svg-container",attached:function(){for(var i=0;i<this.attributes.length;i++)this.$.svg.setAttribute(Polymer.CaseMap.dashToCamelCase(this.attributes[i].name),this.attributes[i].value)}});</script></dom-module><dom-module id="svg-component"><template><content select="svg-component"></content></template><script>SvgComponent=Polymer({is:"svg-component",_node:{},_namespace:"http://www.w3.org/2000/svg",get rootElement(){return"SVG-CONTAINER"===this.parentNode.nodeName?this.parentNode.$.svg:this.parentNode._node},factoryImpl:function(attributes){for(var key in attributes)this.setAttribute(key,attributes[key])},attached:function(){var is=this.attributes.is.value;if(void 0!==is){this._node=document.createElementNS(this._namespace,is);for(var i=0;i<this.attributes.length;i++)"is"!==this.attributes[i].name&&this._node.setAttribute(this.attributes[i].name,this.attributes[i].value);this.rootElement.appendChild(this._node)}}});</script></dom-module><dom-module id="optinomic-pdf-chart-profile"><script>Polymer({is:"optinomic-pdf-chart-profile",properties:{language:{type:String,value:"de"},options:{type:Object,observer:"__init"},start:{type:Object},clinic_samples:{type:Object,observer:"__init"},clinic_sample_dive:{type:Array,observer:"__init"},scales:{type:Object,observer:"__init"},scores:{type:Object,observer:"__init"},ranges:{type:Object,observer:"__init"},pdfContent:{type:Object,notify:!0,reflectToAttribute:!0}},__init:function(){this.debounce("_srChanged",function(){this._hasValue(this.options)&&this._hasValue(this.scales)&&this._hasValue(this.scores)&&this._hasValue(this.ranges)&&this._pdfmake_chart_zscore(this.scores,this.options)},250)},_pdfmake_chart_zscore:function(scores,definition){var d,_return,_inner,_init=function(scores,definition){var d={};d.options=definition,d.options.offset_top=10,"item_height"in d.options?d.options.item_height=d.options.item_height:d.options.item_height=60,"topnumber_hide_first_last"in d.options?d.options.topnumber_hide_first_last=d.options.topnumber_hide_first_last:d.options.topnumber_hide_first_last=!1,"show_ranges_overview"in d.options?d.options.show_ranges_overview=d.options.show_ranges_overview:d.options.show_ranges_overview=!0,"item_text_left"in d.options?d.options.item_text_left=d.options.item_text_left:d.options.item_text_left=73,"item_text_right"in d.options?d.options.item_text_right=d.options.item_text_right:d.options.item_text_right=73,"dropout_flag"in d.options?d.options.dropout_flag=d.options.dropout_flag:d.options.dropout_flag=null,"dropout_reason"in d.options?d.options.dropout_reason=d.options.dropout_reason:d.options.dropout_reason=null;d.options.item_text_left=d.options.item_text_left/2+12,d.options.item_text_right=d.options.item_text_right/2+12,d.options.item_text_left<=62?d.options.legend_left=62:d.options.legend_left=d.options.item_text_left,d.options.chart_width=495-d.options.item_text_left-d.options.item_text_right;"show_scale_text"in d.options&&d.options.show_scale_text;"color_grid"in d.options&&d.options.color_grid,d.scales=this.get("scales"),d.scales.length>0?d.options.chart_height=d.scales.length*d.options.item_height:d.options.chart_height=0,d.ranges=this.get("ranges"),null!==this.clinic_samples&&void 0!==this.clinic_samples?d.ks=this.clinic_samples:d.ks=null;var ks_dive={defined:!1,text:"",data:null,array:[]},clinic_sample_dive=this.get("clinic_sample_dive");return null!==clinic_sample_dive&&void 0!==clinic_sample_dive&&(ks_dive.array=clinic_sample_dive,ks_dive.array.length>0&&(ks_dive.defined=!0)),d.ks_dive=ks_dive,d.options.do_min=!1,"auto"===d.options.min||void 0===d.options.min?d.options.do_min=!0:d.options.item_min=parseInt(d.options.min),d.options.do_max=!1,"auto"===d.options.max||void 0===d.options.max?d.options.do_max=!0:d.options.item_max=parseInt(d.options.max),d.scores=scores.data,d.scores.length>0?(d.have_data=!0,d=_scales_scores(d.scores,d),d=_autoMinMax(d)):d.have_data=!1,console.log("<optinomic-pdf-chart-profile>",d),d}.bind(this),_ks_current_sample=function(d){d.scores[d.scores.length-1];var clinic_sample_dive={defined:!1,text:"",data:null,array:[]};if(d.ks_dive.defined&&(clinic_sample_dive=d.ks_dive),!d.ks_dive.defined&&this._hasValue(this.clinic_samples)&&(this.clinic_samples.dimensions.forEach(function(dim,dimID){clinic_sample_dive.array.push(dim.array.length-1)}),console.log("Defaultstichprobe erstellt!")),d.ks_dive.defined&&this._hasValue(this.clinic_samples)){var dive_data=d.ks.data;d.ks_dive.array.forEach(function(dive,diveID){dive_data=JSON.parse(JSON.stringify(dive_data[dive]))});try{clinic_sample_dive.data=JSON.parse(JSON.stringify(dive_data.statistics))}catch(err){clinic_sample_dive.data={}}var n_value=0;for(var property in clinic_sample_dive.data)clinic_sample_dive.data.hasOwnProperty(property)&&(n_value=clinic_sample_dive.data[property].n);clinic_sample_dive.text="",d.ks.dimensions.forEach(function(dim,dimID){var pos=d.ks_dive.array[dimID],dim_text=dim.name+": "+dim.array[pos].text;dimID!==d.ks.dimensions.length-1&&(dim_text+=", "),clinic_sample_dive.text=clinic_sample_dive.text+dim_text}),0!==n_value&&(clinic_sample_dive.text=clinic_sample_dive.text+" (N="+n_value+")"),clinic_sample_dive.defined=!0}return clinic_sample_dive}.bind(this),_scales_scores=function(scores,init){return init.scales.forEach(function(scale,scaleID){scale.scores=[],scale.id=scaleID,void 0!==scores&&null!==scores&&scores.forEach(function(score,scoreID){var score_obj={value:null,title:"Unbekannt",date:null,dropout:!1,dropout_reason:null};scale.score_path&&(score_obj.value=_getDataPath(score,scale.score_path)),init.options.response_title_path&&(score_obj.title=_getDataPath(score,init.options.response_title_path)),init.options.response_date_path&&(score_obj.date=_getDataPath(score,init.options.response_date_path),score_obj.date=_formatDateCH(score_obj.date)),"dropout_flag"in init.options&&""!==init.options.dropout_flag&&null!==init.options.dropout_flag&&void 0!==init.options.dropout_flag&&(score_obj.dropout=_getDataPath(score,init.options.dropout_flag)),"dropout_reason"in init.options&&""!==init.options.dropout_reason&&null!==init.options.dropout_reason&&void 0!==init.options.dropout_reason&&(score_obj.dropout_reason=_getDataPath(score,init.options.dropout_reason)),scale.scores.push(score_obj)})}),init}.bind(this),_legende_normstichprobe=function(init){if("norm_sample"in init.options){if(this._hasValue(init.options.norm_sample))var normstichprobe={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Normstichprobe"}]},{width:"*",style:"chart_p",alignment:"left",text:[{text:init.options.norm_sample}]}],columnGap:10}}else normstichprobe={};return normstichprobe}.bind(this),_legende_start=function(init){var start=this.get("start"),return_object={};if(void 0!==start&&1==init.ks_dive.defined)return_object={columns:[{width:init.options.item_text_left,style:"chart_p",alignment:"right",color:start.left_color,text:start.left_title},{width:"*",style:"chart_p",alignment:"left",text:[{text:start.left_text}]},{width:"*",style:"chart_p",alignment:"right",text:[{text:start.right_text}]},{width:init.options.item_text_right,style:"chart_p",alignment:"left",color:start.right_color,text:start.right_title}],columnGap:10};return return_object}.bind(this),_getDataPath=function(current_score,path){var data_dive=JSON.parse(JSON.stringify(current_score)),dots_count=path.split(".").length-1;if(0===dots_count)return data_dive[path];var dive=[];for(i=0;i<dots_count;i++){var n=path.indexOf("."),item=path.substring(0,n);path=path.substring(n+1,path.length),dive.push(item),i===dots_count-1&&dive.push(path)}for(i=0;i<dive.length;i++)if(data_dive=data_dive[dive[i]],i===dots_count)return data_dive},_autoMinMax=function(data){var d=JSON.parse(JSON.stringify(data));return(d.options.do_max||d.options.do_min)&&(d.options.do_min&&(d.options.item_min=0),d.options.do_max&&(d.options.item_max=0),d.scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){d.options.do_min&&score.value<d.options.item_min&&(d.options.item_min=score.value),d.options.do_max&&score.value>d.options.item_max&&(d.options.item_max=score.value)})}),d.options.do_min?(d.options.item_min<0?(d.options.item_min=Math.ceil(Math.abs(d.options.item_min))+1,d.options.item_min=-1*d.options.item_min):d.options.item_min=Math.ceil(Math.abs(d.options.item_min))+1,d.options.item_min>0&&(d.options.item_min=0)):d.options.item_min=d.options.min,d.options.do_max?d.options.item_max<0?(d.options.item_max=Math.ceil(Math.abs(d.options.item_max))+1,d.options.item_max=-1*d.options.item_max):d.options.item_max=Math.ceil(Math.abs(d.options.item_max))+1:d.options.item_max=d.options.max),d.options.min_max_range=d.options.item_max-d.options.item_min,d.options.item_min<0&&(d.options.min_max_range=d.options.item_max+Math.abs(d.options.item_min)),d},_getXPos=function(min,max,svg_width_100,current_value){var width_value=null;if(void 0!==current_value){var width_100=Math.abs(min)+Math.abs(max);width_value=svg_width_100/width_100*(current_value+Math.abs(min)),width_value_max=svg_width_100/width_100*(Math.abs(max)+Math.abs(min)),width_value>width_value_max&&(width_value=width_value_max),width_value<0&&(width_value=0)}return width_value},_shadeColor=function(color,percent){var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?-1*percent:percent,R=f>>16,G=f>>8&255,B=255&f;return"#"+(16777216+65536*(Math.round((t-R)*p)+R)+256*(Math.round((t-G)*p)+G)+(Math.round((t-B)*p)+B)).toString(16).slice(1)},_getColor=function(id,color_skin){var colors=[];return"default"===(color_skin=void 0===color_skin?"default":color_skin)&&(colors.push("#3F51B5"),colors.push("#E91E63"),colors.push("#00BCD4"),colors.push("#8BC34A"),colors.push("#FFC107"),colors.push("#795548"),colors.push("#673AB7"),colors.push("#F44336"),colors.push("#03A9F4"),colors.push("#4CAF50"),colors.push("#FFEB3B"),colors.push("#FF5722"),colors.push("#2196F3"),colors.push("#9C27B0"),colors.push("#009688"),colors.push("#CDDC39"),colors.push("#FF9800"),colors.push("#607D8B")),"grey_dark_to_light"===color_skin&&(colors.push("#424242"),colors.push("#9E9E9E"),colors.push("#E0E0E0"),colors.push("#FAFAFA")),"indigo_dark_to_light"===color_skin&&(colors.push("#283593"),colors.push("#3F51B5"),colors.push("#7986CB"),colors.push("#E8EAF6")),"pink_dark_to_light"===color_skin&&(colors.push("#AD1457"),colors.push("#E91E63"),colors.push("#7986CB"),colors.push("#E8EAF6")),"indigo_grey_pink"===color_skin&&(colors.push("#1A237E"),colors.push("#212121"),colors.push("#880E4F"),colors.push("#3F51B5"),colors.push("#9E9E9E"),colors.push("#E91E63"),colors.push("#C5CAE9"),colors.push("#F5F5F5"),colors.push("#F8BBD0")),"zebra"===color_skin&&(colors.push("#212121"),colors.push("#EEEEEE")),id>colors.length-1?colors[id-Math.floor(id/colors.length)*colors.length]:colors[id]},_formatDateCH=function(date_string){if(void 0!==date_string&&null!==date_string){var year=parseInt(date_string.substring(0,4)),month=parseInt(date_string.substring(5,7));return parseInt(date_string.substring(8,10))+"."+month+"."+year}return null},init=_init(scores,definition),chart_stack=[],chart_top=[];if(!0===init.have_data){chart_stack.push(function(d){var _scales_text={id:"scales_text",stack:[]};return d.scales.length>0&&d.scales.forEach(function(scale,scaleID){var left_text=[],right_text=[];if(""!==scale.left_title)if(""!==scale.left_text&&d.options.show_scale_text){var title={text:scale.left_title+": ",bold:!0},text={text:scale.left_text,bold:!1};left_text.push(title),left_text.push(text)}else title={text:scale.left_title,bold:!0},left_text.push(title);else""!==scale.left_text&&(text={text:scale.left_text,bold:!1},left_text.push(text));""!==scale.right_title?""!==scale.right_text&&d.options.show_scale_text?(title={text:scale.right_title+": ",bold:!0},text={text:scale.right_text,bold:!1},right_text.push(title),right_text.push(text)):(title={text:scale.right_title,bold:!0},right_text.push(title)):""!==scale.right_text&&(text={text:scale.right_text,bold:!1},right_text.push(text));var column_scale={columns:[{width:d.options.item_text_left,style:"chart_p",alignment:"right",text:left_text},{width:"*",text:""},{width:d.options.item_text_right,style:"chart_p",alignment:"left",text:right_text}],relativePosition:{x:0,y:scaleID*d.options.item_height+d.options.offset_top},columnGap:10};_scales_text.stack.push(column_scale)}),_scales_text}(init)),chart_stack.push(function(d){var beschriftung_top={id:"numbers_top",stack:[]},grind_count=0;for(i=0;i<d.options.min_max_range+1;i++)if(0===i||grind_count===d.options.vertical_grid_every_x){var my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,d.options.item_min+i),inner={color:"#616161",fontSize:8,alignment:"left",text:d.options.item_min+i,relativePosition:{x:d.options.item_text_left+8+my_x,y:0}};d.options.topnumber_hide_first_last?0!==i&&i!==d.options.min_max_range&&beschriftung_top.stack.push(inner):beschriftung_top.stack.push(inner),grind_count=1}else grind_count+=1;return beschriftung_top}(init)),chart_stack.push((_return={id:"ranges",stack:[]},_inner={relativePosition:{x:(d=init).options.item_text_left+10,y:d.options.offset_top},canvas:[]},d.ranges.forEach(function(range,rangeID){var my_x=0;-999!==range.range_start&&(my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,range.range_start));var my_y=d.options.chart_width;999!==range.range_stop&&(my_y=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,range.range_stop)),range={type:"rect",x:my_x,y:0,w:my_y-my_x,h:d.options.chart_height,color:_shadeColor(range.color,1-d.options.range_alpha)},_inner.canvas.push(range)}),_return.stack.push(_inner),_return)),null!==init.ks&&chart_stack.push(function(d){var _return={id:"clinic_sample",stack:[]},_inner={relativePosition:{x:d.options.item_text_left+10,y:d.options.offset_top},canvas:[]};d.ks_dive=_ks_current_sample(d);var ks_points=[],ks_line_points=[];d.scales.forEach(function(scale,scaleID){var ks_var=d.ks_dive.data[scale.clinic_sample_var]||{},mean_1sd_min=ks_var.mean_1sd_min||0,mean=(ks_var.mean_1sd_plus,ks_var.mean||0),my_y_1=scaleID*d.options.item_height+7;0===scaleID&&(my_y_1=0);var my_y_2=scaleID*d.options.item_height+(d.options.item_height-7);scaleID===d.scales.length-1&&(my_y_2=d.options.chart_height);var point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_min),y:my_y_1},point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_min),y:my_y_2};ks_points.push(point_1),ks_points.push(point_2);var line_point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean),y:my_y_1},line_point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean),y:my_y_2};ks_line_points.push(line_point_1),ks_line_points.push(line_point_2)});var clone_scales=JSON.parse(JSON.stringify(d.scales));clone_scales.reverse(),clone_scales.forEach(function(scale,scaleID){var scaleIDCorrected=clone_scales.length-1-scaleID,ks_var=d.ks_dive.data[scale.clinic_sample_var]||{},mean_1sd_plus=(ks_var.mean_1sd_min,ks_var.mean_1sd_plus||0),my_y_1=(ks_var.mean,scaleIDCorrected*d.options.item_height+(d.options.item_height-7)),my_y_2=scaleIDCorrected*d.options.item_height+7;0===scaleIDCorrected&&(my_y_2=0),scaleIDCorrected===d.scales.length-1&&(my_y_1=d.options.chart_height);var point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_plus),y:my_y_1},point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_plus),y:my_y_2};ks_points.push(point_1),ks_points.push(point_2)});var ks_area={type:"polyline",fillOpacity:.5,color:d.options.color_clinic_sample,points:ks_points};_inner.canvas.push(ks_area);var ks_line={type:"polyline",lineWidth:2,lineColor:_shadeColor(d.options.color_grid,.5),points:ks_line_points};return _inner.canvas.push(ks_line),_return.stack.push(_inner),_return}(init)),chart_stack.push(function(d){var _grid={id:"grid",stack:[]},_grid_inner={relativePosition:{x:d.options.item_text_left+10,y:0},canvas:[{type:"rect",x:0,y:d.options.offset_top,w:d.options.chart_width,h:d.options.chart_height,lineColor:d.options.color_grid}]};d.scales.length>0&&d.scales.forEach(function(scale,scaleID){var horizontal_line={type:"line",x1:0,y1:scaleID*d.options.item_height+d.options.offset_top,x2:d.options.chart_width,y2:scaleID*d.options.item_height+d.options.offset_top,lineWidth:1,lineColor:d.options.color_grid};0!==scaleID&&_grid_inner.canvas.push(horizontal_line)});var grind_count=0;for(i=0;i<d.options.min_max_range;i++)if(grind_count===d.options.vertical_grid_every_x){var my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,d.options.item_min+i),line_width=1;d.options.item_min+i===0&&0!==i&&(line_width=2);var vertical_line={type:"line",x1:my_x,y1:d.options.offset_top,x2:my_x,y2:d.options.chart_height+d.options.offset_top,lineWidth:line_width,lineColor:d.options.color_grid};_grid_inner.canvas.push(vertical_line),grind_count=1}else grind_count+=1;return _grid.stack.push(_grid_inner),_grid}(init)),chart_stack.push(function(d){var _return={id:"scores",stack:[]},_inner={relativePosition:{x:d.options.item_text_left+10,y:d.options.offset_top},canvas:[]},points_obj={},lines_count=0,dots=[];for(d.scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){if(!0!==score.dropout){lines_count=scoreID+1,void 0===points_obj[scoreID]&&(points_obj[scoreID]=[]),my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,score.value);var my_y=scaleID*d.options.item_height+d.options.item_height/2,point={x:my_x,y:my_y};if(points_obj[scoreID].push(point),d.options.show_score_vertical_line){var show_score_vertical_line={type:"line",x1:my_x,y1:scaleID*d.options.item_height,x2:my_x,y2:scaleID*d.options.item_height+d.options.item_height,lineWidth:4,lineColor:_getColor(scoreID,d.options.color_skin)};_inner.canvas.push(show_score_vertical_line)}if(d.options.show_score_circles){var circle_color="#FFFFFF";d.ranges.forEach(function(range,rangeID){score.value>=range.range_start&&score.value<=range.range_stop&&(circle_color=range.color)});var circle={type:"ellipse",x:my_x,y:my_y,color:circle_color,lineColor:_getColor(scoreID,d.options.color_skin),lineWidth:2,fillOpacity:.9,r1:4.25,r2:4.25};dots.push(circle)}}})}),i=0;i<lines_count;i++){var score_line={type:"polyline",lineWidth:3,lineColor:_getColor(i,d.options.color_skin),points:points_obj[i]};_inner.canvas.push(score_line)}return d.options.show_score_circles&&dots.forEach(function(dot,dotID){_inner.canvas.push(dot)}),_return.stack.push(_inner),_return}(init));var spacer={canvas:[{type:"rect",x:-3,y:0,w:0,h:init.options.offset_top+init.options.chart_height+6,lineColor:"#FFFFFF"}]};chart_stack.push(spacer),chart_stack.push(function(init){var messung_title="Keine Daten vorhanden.";1===init.scores.length&&(messung_title="Messung"),init.scores.length>1&&(messung_title="Messungen");var messungen={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:messung_title}]}],columnGap:10};return init.scores.forEach(function(score,scoreID){"dropout_flag"in init.options&&""!==init.options.dropout_flag&&null!==init.options.dropout_flag&&void 0!==init.options.dropout_flag&&(score.dropout_have=_getDataPath(score,init.options.dropout_flag)),"dropout_reason"in init.options&&""!==init.options.dropout_reason&&null!==init.options.dropout_reason&&void 0!==init.options.dropout_reason&&(score.dropout_reason=_getDataPath(score,init.options.dropout_reason));var zuordner={width:10,canvas:[{type:"line",x1:0,y1:8,x2:15,y2:8,lineWidth:4,lineColor:_getColor(scoreID,init.options.color_skin)}]},title=_getDataPath(score,init.options.response_title_path),date=_getDataPath(score,init.options.response_date_path);date=_formatDateCH(date);var dropout_text="";score.dropout_have?(dropout_text="Dropout: ","dropout_reason"in score&&""!==score.dropout_reason&&(dropout_text=dropout_text+_getDataPath(score,init.options.dropout_reason)+" "),""!==dropout_text&&null!==dropout_text&&"null"!==dropout_text&&(date=date+", "+dropout_text)):messungen.columns.push(zuordner);var beschriftung={width:"*",style:"chart_p",alignment:"left",text:[{text:title},{text:" ("+date+")",color:"#757575"}]};messungen.columns.push(beschriftung)}),messungen}(init)),chart_top.push({text:"",margin:[0,0,0,6]}),chart_top.push(_legende_normstichprobe(init)),chart_top.push(function(init){var return_object={};void 0!==init.ks_dive&&1==init.ks_dive.defined&&(return_object={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Klinikstichprobe"}]},{width:"*",style:"chart_p",alignment:"left",text:[{text:init.ks_dive.text}]}],columnGap:10});return return_object}(init)),init.options.show_ranges_overview&&chart_top.push(function(init){var interpretation={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Interpretation"}]}],columnGap:10},beschriftung={width:"*",style:"chart_p",alignment:"left",text:[]};return void 0!==init.ranges&&(init.ranges.forEach(function(range,rangeID){var title=range.text,range_text="";-999!==range.range_start?(range_text=range.range_start,999!==range.range_stop&&(range_text=">"+range_text+" bis ")):range_text="<=",999!==range.range_stop?range_text+=range.range_stop:range_text=">="+range_text;var title_obj={text:title},range_obj={text:" ("+range_text+")",color:"#757575"};beschriftung.text.push(title_obj),beschriftung.text.push(range_obj),rangeID!==init.ranges.length-1&&(title_obj={text:", "},beschriftung.text.push(title_obj))}),interpretation.columns.push(beschriftung)),interpretation}(init)),chart_top.push(_legende_start(init)),chart_top.push({text:"",margin:[0,0,0,6]}),chart_stack=chart_top.concat(chart_stack)}var chart={id:"chart_zscore",layout:"noBorders",table:{dontBreakRows:!0,headerRows:0,body:[[{stack:chart_stack}]]}};return this.set("pdfContent",chart),chart},_hasValue:function(value){return null!==value&&"null"!==value&&void 0!==value&&""!==value},ready:function(){},attached:function(){}});</script></dom-module>

<script type="text/javascript">
// ----------------------------
// Helpers
// ----------------------------

// Add timestamp & API-URL to every request
addOptinomicExtras = function (obj, api_url) {
    api_url = api_url || null;
    obj.api_timestamp = new Date().toISOString();
    obj.api_url = api_url;
    return obj;
};


// Add timestamp & API-URL to every request
handleError = function (req, error_action) {

    var error = {
        "error": true,
        "error_message": "Failed with status code: " + req.status,
        "status": req.status,
        "statusText": req.statusText,
        "responseURL": req.responseURL,
        "readyState": req.readyState,
        "error_action": error_action
    };

    try {
        var responseText = JSON.parse(req.responseText);
        if ("error" in responseText) {
            error.responseErrorText = responseText.error;
        };
    } catch (err) {
        error.responseErrorText = null
    };

    if (req.status !== 0) {
        console.error("(!) " + req.status + " (" + req.statusText + ")", error);
        // window.location.href = "#/errors";
    };

    return error;
};


// Set Value on Obj
function setValue(obj, access, value) {
    //console.error('---> (setValue)', obj, access, value);

    if (typeof (access) == 'string') {
        access = access.split('.');
    }
    if (access.length > 1) {
        var init = obj[access[0]] || {};
        setValue(obj[access.shift()] = init, access, value);
    } else {
        obj[access[0]] = value;
    }
};


debounce = function (fn, wait) {
    var timeout = null;
    var c = function () {
        clearTimeout(timeout);
        timeout = null;
    };
    var t = function (fn) {
        timeout = setTimeout(fn, wait);
    };
    return function () {
        var context = this;
        var args = arguments;
        var f = function () {
            fn.apply(context, args);
        };
        timeout
            ?
            c() || t(f) : t(c) || f();
    }
}


formatDateCH = function (date_string) {
    date_string = date_string || null
    if (date_string !== null) {

        // 1952-11-19T00:00:00.000000000000Z
        var year = parseInt(date_string.substring(0, 4));
        var month = parseInt(date_string.substring(5, 7));
        var day = parseInt(date_string.substring(8, 10));
        var date_string_return = day + "." + month + "." + year

        return date_string_return;
    } else {
        return null;
    }
};

createPatientExtras = function (patient) {

    function getAge(dateString) {
        var today = new Date();
        var birthDate = new Date(dateString);
        var age = today.getFullYear() - birthDate.getFullYear();
        var m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }
    
    

    // patient.age = $filter('dateToAge')(patient.birthdate);
    // patient.birthday = $filter('date')(patient.birthdate);

    patient.extras = {};
    patient.extras.age = getAge(patient.birthdate);

    patient.extras.birthday = formatDateCH(patient.birthdate);
    patient.extras.birthday_age = patient.extras.birthday + ' | ' + patient.extras.age;


    patient.extras.name = patient.last_name + ' ' + patient.first_name;

    var birthYear = new Date(patient.birthdate);
    birthYear = birthYear.getFullYear();
    patient.extras.birth_year = birthYear;
    patient.extras.secure = patient.last_name.substring(0, 2) + '. ' + patient.first_name.substring(0, 1) + '. (' + birthYear + ')';

    if (patient.gender === 'male') {
        patient.extras.ansprache = 'Herr';
        patient.extras.anrede = 'Herr ' + patient.last_name;
    } else {
        patient.extras.ansprache = 'Frau';
        patient.extras.anrede = 'Frau ' + patient.last_name;
    };
    patient.extras.full_name = patient.extras.ansprache + ' ' + patient.extras.name + ' (' + patient.extras.birthday_age + ')';

    patient.extras.full_address = patient.address1 + ', ' + patient.zip_code + ' ' + patient.city;

    var myPhone = '';
    if (patient.phone_home) {
        myPhone = patient.phone_home;
    }
    if (patient.phone_mobile) {
        if (myPhone != '') {
            myPhone = myPhone + ', ' + patient.phone_mobile;
        } else {
            myPhone = patient.phone_mobile;
        }
    }
    patient.extras.phone = myPhone;
    patient.extras.infoline = patient.extras.full_address

    if (myPhone != '') {
        patient.extras.infoline + ' | ' + patient.extras.phone;
    };


    // -----------------------------------
    // Female = Pink | Male = Blue
    // -----------------------------------
    var myColor = "#3F51B5";
    var myColorAccent = "#E91E63";
    if (patient.gender === "female") {
        myColor = "#E91E63";
        myColorAccent = "#3F51B5";
    }
    patient.extras.color_main = myColor;
    patient.extras.color_accent = myColorAccent;

    return patient.extras;
};

createStayExtras = function (current_stay) {
    current_stay.extras = {};
    current_stay.extras.in_stay = false;

    // Calculate - Duration of the stay
    if (current_stay.stop) {
        current_stay.extras.duration = Math.floor((Date.parse(current_stay.stop) - Date.parse(current_stay.start)) / 86400000);
        current_stay.extras.duration = current_stay.extras.duration + 1; //incl. start & stop date
    } else {
        current_stay.extras.duration = Math.floor((new Date() - Date.parse(current_stay.start)) / 86400000);
    };

    // phase - translation
    var phase = current_stay.phase;
    var translated_de = "";
    if (phase === 'before_stay') {
        translated_de = "Bevorstehende Behandlung";
        translated_en = "the stay starts in the future";
    };
    if (phase === 'in_stay') {
        translated_de = "In aktueller Behandlung";
        translated_en = "the patient is currently in stay";
        current_stay.extras.in_stay = true;
    };
    if (phase === 'after_exit') {
        translated_de = "Die Behandlung wurde vor weniger als 14 Tage beendet";
        translated_en = "the stay ended less than 14 days ago (included)";
    };
    if (phase === 'frozen') {
        translated_de = "Die Behandlung wurde manuell eingefroren";
        translated_en = "the stay has manually been frozen (no more events, changes, ...)";
    };
    if (phase === 'unfrozen') {
        translated_de = "Die Behandlung ist abgeschlossen, wurde jedoch zur Bearbeitung wieder ge√∂ffnet";
        translated_en = "the stay is complete but has been unfrozen by somebody";
    };
    if (phase === 'complete') {
        translated_de = "Die Behandlung wurde vor mehr als 14 Tage beendet";
        translated_en = "the stay ended more than 14 days ago";
    };
    current_stay.extras.phase_de = translated_de;
    current_stay.extras.phase_en = translated_en;

    // from_to
    current_stay.extras.beginn = formatDateCH(current_stay.start);
    current_stay.extras.from_to = formatDateCH(current_stay.start);
    current_stay.extras.from_to = current_stay.extras.from_to + ' - ';
    if (current_stay.stop) {
        current_stay.extras.from_to = current_stay.extras.from_to + formatDateCH(current_stay.stop);
        current_stay.extras.ende = formatDateCH(current_stay.stop);
    } else {
        current_stay.extras.from_to = current_stay.extras.from_to + "Unbekannt";
    };

    return current_stay.extras;
};

createEventExtras = function (current_event) {
    var extras = {};

    extras.created_at = formatDateCH(current_event.created_at);
    extras.due = formatDateCH(current_event.due);
    extras.status = current_event.status.charAt(0).toUpperCase() + current_event.status.slice(1);

    extras.status_de = "Undefined";
    if (current_event.status === 'done') {
        extras.status_de = "Erledigt";
        extras.show_do_it_now = false;
    };
    if (current_event.status === 'to_be_done') {
        extras.status_de = "Offen";
        extras.show_do_it_now = true;
    };
    if (current_event.status === 'aborted') {
        extras.status_de = "Abgebrochen";
        extras.show_do_it_now = false;
    };
    if (current_event.status === 'irrelevant') {
        extras.status_de = "Nicht relevant";
        extras.show_do_it_now = false;
    };

    return extras;
};    
    
</script>

<script>

// Optinomic App-Optinomic
Vue.component('app-optinomic', {
    props: {
        title: {
            type: String,
            default: "Optinomic"
        },
        subtitle: {
            type: String,
            default: "App"
        }
    },
    created() {
        this.$store.dispatch('getSurveyResponses');
        this.$store.dispatch('getUser');
        if (helpers.getPatientID() !== 0) {
            this.$store.dispatch('getPatient');
        };
        this.$store.dispatch('getClinic');
    },
    computed: {
        sr() {
            // get survey_response
            try {
                return this.$store.state.sr;
            } catch (e) {
                return {};
            };
        },
        loaded() {
            // get survey_response
            try {
                if ((this.$store.state.sr.have_data === true) || (this.$store.state.sr.have_data === false)) {
                    return true;
                };
            } catch (e) {
                return false;
            };
        },
        user_text() {
            // get survey_response
            try {
                return this.$store.state.user.data.first_name + " " + this.$store.state.user.data.last_name + " (" + this.$store.state.user.data.initials + ")";
            } catch (e) {
                return '';
            };
        },
        clinic_data() {
            // get survey_response
            try {
                return this.$store.state.clinic.data;
            } catch (e) {
                return false;
            };
        },
        missing_data() {
            // get survey_response
            if (this.$store.state.sr === null) {
                return false;
            } else {
                var sr = this.$store.state.sr.data;
                var data_errors = false;
                sr.forEach(function (item) {
                    if (item.all_found === false) {
                        data_errors = true;
                    };
                });
                return data_errors;
            };
        }
    },
    template: `
    <template>
        <v-app id="top" style="background-color:#f8f8f8!important;">
            <v-content>
                <v-container class="mt-10 mb-4 pt-8 pb-12 pl-10 pr-8 elevation-1" style="background-color:white!important;">

                    <v-row>
                        <v-col cols="12" sm="6">
                            <img v-if="clinic_data" :src="clinic_data.clinic_logo" :alt="clinic_data.clinic_slogan"
                                height="46">
                            <v-skeleton-loader v-if="!clinic_data" height="46px" max-width="240px" type="image">
                            </v-skeleton-loader>
                        </v-col>
                        <v-col cols="12" sm="6">
                            <optinomic-toc></optinomic-toc>
                        </v-col>
                    </v-row>

                    <app-title :title="title" :subtitle="subtitle" class="mt-4"></app-title>

                    <div v-if="loaded">
                        <div v-if="sr.have_data">
                            <optinomic-content-block title="Missings" subtitle="Datenhinweis" id="data_note" 
                                v-if="missing_data">
                                <div v-for="r in sr.data">
                                    <div v-if="r.all_found === false">
                                        <v-alert dense outlined text type="error">
                                            <p style="margin:0;padding:0">Bei der Messung vom <span
                                                    v-html="formatDateCH(r.date)"></span> sind nicht alle Daten vorhanden:
                                            </p>
                                            <p style="margin:0;padding:0" v-if="r.calculation_found === false">
                                                - Calculation nicht gefunden / noch nicht berechnet!
                                            </p>
                                            <p style="margin:0;padding:0" v-if="r.event_found === false">
                                                - Event <span v-html="r.event_id"></span> nicht gefunden.
                                            </p>
                                            <p style="margin:0;padding:0" v-if="r.patient_found === false">
                                                - Patient <span v-html="r.patient_id"></span> nicht gefunden.
                                            </p>
                                            <p style="margin:0;padding:0" v-if="r.stay_found === false">
                                                - Fall <span v-html="r.stay_id"></span> nicht gefunden.
                                            </p>
                                        </v-alert>
                                    </div>
                                </div>
                            </optinomic-content-block>
                            <slot></slot>
                        </div>
                        <div v-else>
                            <optinomic-content-block subtitle="Hinweis" title="Keine Messdaten" id="in_no_data" show_in_toc="false">
                                <v-alert prominent text type="error">
                                    Es sind keine Messdaten vorhanden.
                                </v-alert>
                            </optinomic-content-block>
                        </div>
                    </div>
                    <div v-else>
                        <v-sheet class="px-3 pt-3 pb-3">
                            <v-skeleton-loader class="mx-auto" type="card"></v-skeleton-loader>
                        </v-sheet>
                    </div>
                    <div class="mt-12 pt-12 ml-4 mr-6">
                        <v-row style="border-top: 1px solid #8b0042;">
                            <v-col cols="12" sm="6" class="px-0">
                                <p class="subtitle-1 font-italic font-weight-thin text-left" style="color:#8b0042"
                                    v-text="clinic_data.clinic_slogan" v-if="clinic_data"></p>
                            </v-col>
                            <v-col cols="12" sm="6" class="px-0">
                                <v-btn class="ml-1" style="float:right;" icon x-small color="#8b0042" @click="$vuetify.goTo('#top')">
                                    <v-icon dark>mdi-arrow-up</v-icon>
                                </v-btn>
                                <p class="caption font-weight-light text-right" v-text="user_text"></p>
                            </v-col>
                        </v-row>
                    </div>
                </v-container>
            </v-content>
        </v-app>
    </template>
    `
});


// Optinomic App-Title
Vue.component('app-title', {
    props: {
        title: {
            type: String,
            default: "Optinomic"
        },
        subtitle: {
            type: String,
            default: "App"
        }
    },
    created() {
        this.$store.dispatch('getApps');
    },
    computed: {
        readme_html() {
            try {
                return this.$store.state.current_app.module.readme.html;
            } catch (e) {
                return null;
            };
        },
        app_description() {
            try {
                return this.$store.state.current_app.module.description;
            } catch (e) {
                return null;
            };
        },
        app_data() {
            try {
                return this.$store.state.current_app;
            } catch (e) {
                return null;
            };
        },
        clinic_data() {
            // get survey_response
            try {
                return this.$store.state.clinic.data;
            } catch (e) {
                return false;
            };
        },
        patient_text() {
            try {
                return this.$store.state.patient.data.extras.full_name;
            } catch (e) {
                return null;
            };
        }
    },
    template: `
        <div>
            <h1 v-text="title" class="display-1 font-weight-medium"></h1>
            <p style="margin-left:1px;color:#8b0042">
                <span v-text="subtitle"></span>
                <span v-if="patient_text" class="mx-1" style="color:#616161">|</span>
                <span v-if="patient_text" v-text="patient_text"></span>
            </p>

            <optinomic-content-block title="Dokumentation" subtitle="Readme" id="id_readme">
                <v-expansion-panels flat light tile v-if="readme_html === null">
                    <v-expansion-panel disabled>
                        <v-expansion-panel-header style="padding:0">
                            <v-skeleton-loader class="" min-width="200" max-width="550" type="heading"></v-skeleton-loader>
                        </v-expansion-panel-header>
                    </v-expansion-panel>
                </v-expansion-panels>

                <v-expansion-panels flat light tile v-if="readme_html !== null">
                    <v-expansion-panel>
                        <v-expansion-panel-header style="margin:0; padding:0;">
                            <p class="text--primary body-1 mx-auto">
                                <span v-text="app_description"></span>
                                <span class="overline mx-2" style="color:#8b0042">[ </span>
                                <span class="overline">Mehr</span>
                                <span class="overline mx-2" style="color:#8b0042">]</span>
                            </p>
                        </v-expansion-panel-header>
                        <v-expansion-panel-content class="mx-0 px-0" style="margin:0; padding:0;">
                            <!-- Readme -->
                            <div style="border-bottom: 1px solid #8b0042">&nbsp;</div>
                            <p class="overline mt-1 pb-1" style="margin-left:1px;color:#8b0042">README.md</p>
                            <div class="mt-2" v-html="readme_html"></div>
                            <!-- Info-Table -->
                            <div class="mt-6" style="border-bottom: 1px solid #8b0042">&nbsp;</div>
                            <p class="overline mt-1 pb-1" style="margin-left:1px;color:#8b0042">Applikation - Info</p>
                            <v-simple-table>
                                <template v-slot:default>
                                    <tbody>
                                        <tr>
                                            <td>Licensed</td>
                                            <td>
                                                <a :href="clinic_data.clinic_www" target="_blank" v-text="clinic_data.clinic_name + ', ' + clinic_data.clinic_address"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Administrator</td>
                                            <td>
                                                <a :href="'mailto:'+ clinic_data.admin_email" v-text="clinic_data.admin_name"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Updated @ <span v-text="formatDateCH(app_data.module_activation.data.last_update)"></span></td>
                                            <td>
                                                <a :href="'https://github.com/Optinomic/' + app_data.module.identifier" target="_blank" v-text="app_data.module.identifier"></a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </template>
                            </v-simple-table>
                            <v-divider></v-divider>
                        </v-expansion-panel-content>
                    </v-expansion-panel>
                </v-expansion-panels>
            </optinomic-content-block>
        </div>
    `
});

// optinomic-pdfmake
Vue.component('optinomic-pdfmake', {
    props: {
        headerLeft: {
            type: String,
            default: ""
        },
        headerRight: {
            type: String,
            default: ""
        },
        footerLeft: {
            type: String,
            default: ""
        },
        documentTitle: {
            type: String
        },
        content: {
            type: Array,
            default: null
        },
        pageSize: {
            type: String,
            default: 'A4'
        },
        pageOrientation: {
            type: String,
            default: 'portrait'
        },
        hideLogo: {
            type: Boolean,
            default: false
        },
        hidePageNumbers: {
            type: Boolean,
            default: false
        }
    },
    data: function () {
        return {
            pdf_request_possible: true,
            loadingString: "...",
            doc_title: makepdf._create_document_name(this.documentTitle, this.headerLeft)
        }
    },
    mounted() {

    },
    computed: {
        sr_data() {
            // return data
            try {
                return this.$store.state.sr.data;
            } catch (e) {
                return [];
            };
        }
    },
    methods: {
        __open_pdf: function () {

            var dd = makepdf._create_document(this.documentTitle, this.headerLeft, this.headerRight, this.footerLeft, this.pageSize, this.pageOrientation, this.hideLogo, this.hidePageNumbers);
            
            dd.content = this.content;
            dd = makepdf._addFooter(dd, this.footerLeft, this.hidePageNumbers);

            console.log('PDF | open :: ' + this.doc_title, dd);
            this.pdf_request_possible = false;
            pdfMake.createPdf(dd).open();
        },
        __download_pdf: function () {

            var dd = makepdf._create_document(this.documentTitle, this.headerLeft, this.headerRight, this.footerLeft, this.pageSize, this.pageOrientation, this.hideLogo, this.hidePageNumbers);
            
            dd.content = this.content;
            dd = makepdf._addFooter(dd, this.footerLeft, this.hidePageNumbers);
            console.log('PDF | download :: ' + this.doc_title, dd);
            this.pdf_request_possible = false;
            pdfMake.createPdf(dd).download(this.doc_title);
        }
    },
    template: `
        <div class="d-flex flex-row justify-space-between align-center">
            <img class="ml-1 mr-2" style="margin-top:-24px;" width="20px"
                src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4Ij4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNNDk0LjQ3OSwxMzguNTU3TDM2NC4wNCwzLjAxOEMzNjIuMTgzLDEuMDksMzU5LjYyMSwwLDM1Ni45NDUsMGgtMTk0LjQxYy0yMS43NTcsMC0zOS40NTgsMTcuNjk0LTM5LjQ1OCwzOS40NDJ2MTM3Ljc4OSAgICBINDQuMjljLTE2LjI3OCwwLTI5LjUyMSwxMy4yMzktMjkuNTIxLDI5LjUxM3YxNDcuNzQ0QzE0Ljc2OSwzNzAuNzYxLDI4LjAxMiwzODQsNDQuMjksMzg0aDc4Ljc4N3Y4OC42MjcgICAgYzAsMjEuNzEsMTcuNzAxLDM5LjM3MywzOS40NTgsMzkuMzczaDI5NS4yMzhjMjEuNzU3LDAsMzkuNDU4LTE3LjY1MywzOS40NTgtMzkuMzUxVjE0NS4zODUgICAgQzQ5Ny4yMzEsMTQyLjgzOSw0OTYuMjQ0LDE0MC4zOTIsNDk0LjQ3OSwxMzguNTU3eiBNMzU5LjM4NSwyNi41ODFsMTA3LjA3OSwxMTEuMjY1SDM1OS4zODVWMjYuNTgxeiBNNDQuMjksMzY0LjMwOCAgICBjLTUuNDIsMC05LjgyOC00LjQwNS05LjgyOC05LjgyVjIwNi43NDRjMC01LjQxNSw0LjQwOS05LjgyMSw5LjgyOC05LjgyMWgyNjUuODgyYzUuNDIsMCw5LjgyOCw0LjQwNiw5LjgyOCw5LjgyMXYxNDcuNzQ0ICAgIGMwLDUuNDE1LTQuNDA5LDkuODItOS44MjgsOS44Mkg0NC4yOXogTTQ3Ny41MzgsNDcyLjY0OWMwLDEwLjg0LTguODY3LDE5LjY1OS0xOS43NjYsMTkuNjU5SDE2Mi41MzUgICAgYy0xMC44OTksMC0xOS43NjYtOC44MjgtMTkuNzY2LTE5LjY4VjM4NGgxNjcuNDAzYzE2LjI3OCwwLDI5LjUyMS0xMy4yMzksMjkuNTIxLTI5LjUxMlYyMDYuNzQ0ICAgIGMwLTE2LjI3NC0xMy4yNDMtMjkuNTEzLTI5LjUyMS0yOS41MTNIMTQyLjc2OVYzOS40NDJjMC0xMC44OTEsOC44NjctMTkuNzUsMTkuNzY2LTE5Ljc1aDE3Ny4xNTd2MTI4ICAgIGMwLDUuNDM4LDQuNDA5LDkuODQ2LDkuODQ2LDkuODQ2aDEyOFY0NzIuNjQ5eiIgZmlsbD0iIzAwMDAwMCIvPgoJPC9nPgo8L2c+CjxnPgoJPGc+CgkJPHBhdGggZD0iTTEzMi40ODEsMjQ5Ljg5NGMtMy4yNjktNC4yNS03LjMyNy03LjAxLTEyLjE3My04LjI3OWMtMy4xNTQtMC44NDYtOS45MjMtMS4yNjktMjAuMzA4LTEuMjY5SDcyLjU5NnY4NC41NzdoMTcuMDc3ICAgIHYtMzEuOTA0aDExLjEzNWM3LjczMSwwLDEzLjYzNS0wLjQwNCwxNy43MTItMS4yMTJjMy0wLjY1NCw1Ljk1Mi0xLjk5LDguODU2LTQuMDFjMi45MDQtMi4wMTksNS4yOTgtNC43OTgsNy4xODMtOC4zMzYgICAgYzEuODg1LTMuNTM4LDIuODI3LTcuOTA0LDIuODI3LTEzLjA5NkMxMzcuMzg1LDI1OS42MzQsMTM1Ljc1LDI1NC4xNDQsMTMyLjQ4MSwyNDkuODk0eiBNMTE3Ljg1NiwyNzMuMTczICAgIGMtMS4yODgsMS44ODUtMy4wNjcsMy4yNjktNS4zMzcsNC4xNTRzLTYuNzY5LDEuMzI3LTEzLjUsMS4zMjdoLTkuMzQ2di0yNGg4LjI1YzYuMTU0LDAsMTAuMjUsMC4xOTIsMTIuMjg4LDAuNTc3ICAgIGMyLjc2OSwwLjUsNS4wNTgsMS43NSw2Ljg2NSwzLjc1YzEuODA4LDIsMi43MTIsNC41MzksMi43MTIsNy42MTVDMTE5Ljc4OSwyNjkuMDk2LDExOS4xNDQsMjcxLjI4OCwxMTcuODU2LDI3My4xNzN6IiBmaWxsPSIjMDAwMDAwIi8+Cgk8L2c+CjwvZz4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNMjE5LjQ4MSwyNjMuNDUyYy0xLjg0Ni01LjQwNC00LjUzOS05Ljk3MS04LjA3Ny0xMy43MDJzLTcuNzg5LTYuMzI3LTEyLjc1LTcuNzg5Yy0zLjY5Mi0xLjA3Ny05LjA1OC0xLjYxNS0xNi4wOTYtMS42MTUgICAgaC0zMS4yMTJ2ODQuNTc3aDMyLjEzNWM2LjMwOCwwLDExLjM0Ni0wLjU5NiwxNS4xMTUtMS43ODljNS4wMzktMS42MTUsOS4wMzktMy44NjUsMTItNi43NWMzLjkyMy0zLjgwOCw2Ljk0Mi04Ljc4OCw5LjA1OC0xNC45NDIgICAgYzEuNzMxLTUuMDM5LDIuNTk2LTExLjAzOSwyLjU5Ni0xOEMyMjIuMjUsMjc1LjUxOSwyMjEuMzI3LDI2OC44NTYsMjE5LjQ4MSwyNjMuNDUyeiBNMjAyLjg2NSwyOTguMTgzICAgIGMtMS4xNTQsMy43ODktMi42NDQsNi41MS00LjQ3MSw4LjE2M2MtMS44MjcsMS42NTQtNC4xMjUsMi44MjctNi44OTQsMy41MTljLTIuMTE1LDAuNTM5LTUuNTU4LDAuODA4LTEwLjMyNywwLjgwOGgtMTIuNzV2MCAgICB2LTU2LjAxOWg3LjY3M2M2Ljk2MSwwLDExLjYzNSwwLjI2OSwxNC4wMTksMC44MDhjMy4xOTIsMC42OTIsNS44MjcsMi4wMTksNy45MDQsMy45ODFjMi4wNzcsMS45NjIsMy42OTIsNC42OTIsNC44NDYsOC4xOTIgICAgYzEuMTU0LDMuNSwxLjczMSw4LjUxOSwxLjczMSwxNS4wNThDMjA0LjU5NiwyODkuMjMxLDIwNC4wMTksMjk0LjM5NCwyMDIuODY1LDI5OC4xODN6IiBmaWxsPSIjMDAwMDAwIi8+Cgk8L2c+CjwvZz4KPGc+Cgk8Zz4KCQk8cG9seWdvbiBwb2ludHM9IjI5NC44MjcsMjU0LjY1NCAyOTQuODI3LDI0MC4zNDYgMjM2Ljg0NiwyNDAuMzQ2IDIzNi44NDYsMzI0LjkyMyAyNTMuOTIzLDMyNC45MjMgMjUzLjkyMywyODguOTgxICAgICAyODkuMjMxLDI4OC45ODEgMjg5LjIzMSwyNzQuNjczIDI1My45MjMsMjc0LjY3MyAyNTMuOTIzLDI1NC42NTQgICAiIGZpbGw9IiMwMDAwMDAiLz4KCTwvZz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K" />
        
            <p v-text="doc_title" class="mr-auto"></p>
        
            <v-btn v-if="pdf_request_possible" outlined small rounded color="#a1a1a1" class="mr-1" v-on:click="__download_pdf">
                Herunterladen
            </v-btn>
            <v-btn v-if="pdf_request_possible" outlined small rounded color="#8b0042" class="mr-1" v-on:click="__open_pdf">
                √ñffnen
            </v-btn>
            <p v-if="!pdf_request_possible" class="caption">PDF created.</p>
        </div>
    `
});

// optinomic-content-block
Vue.component('optinomic-content-block', {
    props: {
        title: {
            type: String,
            default: "Optinomic"
        },
        subtitle: {
            type: String,
            default: ""
        },
        id: {
            type: String,
            default: "id_undefined"
        },
        show_in_toc: {
            type: Boolean,
            default: true
        },
        toc_pushed: {
            type: Boolean,
            default: false
        }
    },
    data: () => ({}),
    created() {
        if ((this.toc_pushed === false) && (this.show_in_toc === true)) {
            var toc = this.$store.state.table_of_contents.slice(0);
            var toc_entry = {
                title: this.title,
                subtitle: this.subtitle,
                id: this.id
            };
            toc.push(toc_entry);
            this.toc_pushed = true;

            this.$store.commit({
                type: 'saveData',
                root: 'table_of_contents',
                data: toc
            });
        };
    },
    computed: {},
    template: `
        <div class="mb-6 pt-8" :id="id">
            <div class="d-flex flex-row justify-space-between align-end">
                <div>
                    <p class="overline" style="margin-left:1px;color:#8b0042" v-html="subtitle"></p>
                    <h2 class="headline font-weight-light text--secondary" v-html="title" style="margin-top:-16px"></h2>
                </div>
                <div>
                    <v-btn icon x-small color="#8b0042" @click="$vuetify.goTo('#top')">
                        <v-icon dark>mdi-arrow-up</v-icon>
                    </v-btn>
                </div>
            </div>
            <v-divider></v-divider>
            <div class="mt-6 mb-4">
                <slot></slot>
            </div>
        </div>
    `
});

// Optinomic optinomic-toc
Vue.component('optinomic-toc', {
    props: {},

    computed: {
        toc_data() {
            // return data
            try {
                //console.log('TOC', this.$store.state.table_of_contents);
                return this.$store.state.table_of_contents;
            } catch (e) {
                return [];
            };
        }
    },
    template: `
        <div class="d-flex flex-row justify-start">
        
            <div class="mb-12 mt-2">
                <div class="ml-5 mb-2">
                    <p class="overline" style="color:#8b0042">Table of Contents</p>
                    <h2 class="headline font-weight-light text--secondary" style="margin-top:-22px">Inhaltsverzeichnis</h2>
                </div>
                <p class="d-flex flex-row align-top" v-for="item in toc_data" :key="item.id" style="margin:0">
                    <span class="body-1 font-weight-black" style="color:#8b0042">-</span>
                    <a style="color:#212121" class="ml-3" @click="$vuetify.goTo('#'+item.id)">
                        <v-tooltip left>
                            <template v-slot:activator="{ on }">
                                <span v-on="on" class="body-1 font-weight-light" v-text="item.title"></span>
                            </template>
                            <span class="caption mx-1" v-text="item.subtitle"></span>
                        </v-tooltip>
                    </a>
                </p>
            </div>
        
        </div>
    `
});

// optinomic-data-table
Vue.component('optinomic-data-table', {
    props: {
        rows: {
            type: Array,
            default: []
        },
        interpretations: {
            type: Object,
            default: {}
        }
    },
    data() {
        return {
            headers: [{
                    text: 'Variable',
                    value: 'variable',
                    width: 20
                },
                {
                    text: 'Frage | Item',
                    align: 'start',
                    value: 'name',
                }
            ]
        }
    },
    methods: {
        flattenObject: function (ob) {
            var toReturn = {};
            try {
                for (var i in ob) {
                    if (!ob.hasOwnProperty(i)) continue;

                    if ((typeof ob[i]) == 'object' && ob[i] !== null) {
                        var flatObject = this.flattenObject(ob[i]);
                        for (var x in flatObject) {
                            if (!flatObject.hasOwnProperty(x)) continue;
                            toReturn[i + '.' + x] = flatObject[x];
                        }
                    } else {
                        toReturn[i] = ob[i];
                    }
                }
            } catch (e) {
                console.log('flattenObject', e);
            }
            return toReturn;
        }
    },
    computed: {
        rows_extended() {
            try {
                var new_rows = this.rows.slice();
                var sr = this.$store.state.sr.data;
                var sr_pushed = -99;

                if ((new_rows.length > 0) && (sr.length > 0)) {
                    sr.forEach(function (item, item_index) {
                        new_rows.forEach(function (row, row_index) {

                            var r_flat = this.flattenObject(item);
                            
                            // console.log('FLAT', r_flat);
                            
                            var computed_variablename = r_flat.event_id + '__measurment';
                            var new_header = {
                                text: formatDateCH(r_flat.date),
                                value: computed_variablename
                            };
                            if (sr_pushed !== item_index) {
                                this.headers.push(new_header);
                                sr_pushed = item_index;
                            };

                            // Interpretation
                            try {
                                if (row.interpretation !== null) {
                                    var current_interpretation = this.interpretations[row.interpretation].slice();

                                    var value = r_flat[row.path];
                                    current_interpretation.forEach(function (i) {
                                        if ((i.value + '') === (value + '')) {
                                            value = i.value + ', ' + i.text;    
                                        };
                                    }.bind(this));
                                    row[computed_variablename] = value;
                                };
                            } catch (e) {
                                row[computed_variablename] = r_flat[row.path];
                            };

                        }.bind(this));
                    }.bind(this));
                };
                return new_rows;
            } catch (e) {
                console.error('rows_extended', e);
                return this.rows;
            }
        }
    },
    template: `
        <div>
            <v-data-table
              :headers="headers"
              :items="rows_extended"
              :items-per-page="rows.length"
              hide-default-footer
              
            >
                <template v-slot:item.variable="{ item }">
                <kbd v-text="item.variable">v</kbd>

                </template>
            </v-data-table>
            </optinomic-content-block>
        </div>
    `
});

// optinomic-clipboard-text
Vue.component('optinomic-clipboard-text', {
    props: {
        text: {
            type: String,
            default: ""
        }
    },
    data: () => ({
        snackbar: false,
        alert_text: '',
        alert_color: 'error',
        timeout: 2000,
    }),
    methods: {
        copyClipboard() {
            try {
                let textToCopy = document.querySelector('#clipboard-text')
                textToCopy.setAttribute('type', 'text')
                textToCopy.select()

                var successful = document.execCommand('copy');
                if (successful) {
                    this.alert_text = '‚úì Erfolgreich in die Zwischenablage kopiert.';
                    this.alert_color = 'success';
                } else {
                    this.alert_text = 'Oops, der Text konnte nicht in die Zwischenablage kopiert werden.';
                };

                /* unselect the range */
                textToCopy.setAttribute('type', 'hidden')
                window.getSelection().removeAllRanges()
            } catch (err) {
                this.alert_text = "Oops, kopieren in die Zwischenablage ist nicht m√∂glich.";
            }
            this.snackbar = true;
        },
    },
    computed: {},
    template: `
        <div>
            <v-tooltip left>
                <template v-slot:activator="{ on }">
                    <span v-on="on" style="float:right;">
                        <v-btn @click="copyClipboard" icon color="indigo">
                            <v-icon>mdi-content-copy</v-icon>
                        </v-btn>
                    </span>
                </template>
                <span>Kopiere in die Zwischenablage.</span>
            </v-tooltip>
        
            <p class="text--primary body-1" v-text="text">optinomic-clipboard-text</p>
        
            <input type="hidden" id="clipboard-text" :value="text">
            
            <v-snackbar v-model="snackbar" :timeout="timeout" :color="alert_color">
                <span v-text="alert_text"></span>
            </v-snackbar>
        </div>
    `
});

// HoNOS-Application
Vue.component('app-honos', {
    props: {},
    created() {},
    data: function () {
        return {
            "base_config": {
                "dist_root": "dist",
                "app_id": "ch.suedhang.apps.honos.production",
                "app_name": "HoNOS",
                "app_short_description": "Health of the Nations Outcome Scale",
                "app_type": "patient"
            },
            "pdf_content": [],
            "data_table": {
                "rows": [{
                        "name": "Zeitpunkt",
                        "variable": "zeitpunkt_honos",
                        "path": "calculation.honos_calculation.type.name"
                    },
                    {
                        "name": "Verhaltensst√∂rungen",
                        "variable": "honos_h1",
                        "path": "response.H1[402V01]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Selbstverletzung",
                        "variable": "honos_h2",
                        "path": "response.H1[402V02]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Sucht",
                        "variable": "honos_h3",
                        "path": "response.H1[402V03]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Kognitive Probleme",
                        "variable": "honos_h4",
                        "path": "response.H1[402V04]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "K√∂rperliche Probleme",
                        "variable": "honos_h5",
                        "path": "response.H1[402V05]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Wahn",
                        "variable": "honos_h6",
                        "path": "response.H1[402V06]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Gedr√ºckte Stimmung",
                        "variable": "honos_h7",
                        "path": "response.H1[402V07]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Andere Probleme",
                        "variable": "honos_h8",
                        "path": "response.H1[402V08]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Art, Andere Probleme",
                        "variable": "honos_h8a",
                        "path": "response.q402V09",
                        "interpretation": "andereart"
                    },
                    {
                        "name": "Weitere Spezifikation",
                        "variable": "honos_h8b",
                        "path": "response.q402V10"
                    },
                    {
                        "name": "Beziehungen",
                        "variable": "honos_h9",
                        "path": "response.H2[402V11]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Allt√§gliche Aktivit√§ten",
                        "variable": "honos_h10",
                        "path": "response.H2[402V12]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Wohnbedingungen",
                        "variable": "honos_h11",
                        "path": "response.H2[402V13]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Beruf und Alltag",
                        "variable": "honos_h12",
                        "path": "response.H2[402V14]",
                        "interpretation": "problemeinschaetzung"
                    },
                    {
                        "name": "Dropout Code",
                        "variable": "dropoutcode_honos",
                        "path": "dropout.dropout_id"
                    },
                    {
                        "name": "Dropout",
                        "variable": "spezifikation_dropout",
                        "path": "dropout.dropout_raeson"
                    },
                    {
                        "name": "Totalsumme (Œ£)",
                        "variable": "sum_total",
                        "path": "calculation.honos_calculation.sum_score.sum_total"
                    }
                ],
                "interpretations": {
                    "problemeinschaetzung": [{
                            "value": 0,
                            "text": "keine"
                        },
                        {
                            "value": 1,
                            "text": "gering"
                        },
                        {
                            "value": 2,
                            "text": "leicht"
                        },
                        {
                            "value": 3,
                            "text": "m√§ssig"
                        },
                        {
                            "value": 4,
                            "text": "schwer"
                        },
                        {
                            "value": 9,
                            "text": "k.A."
                        }
                    ],
                    "andereart": [{
                            "value": "a",
                            "text": "Phobisch"
                        },
                        {
                            "value": "b",
                            "text": "Angst"
                        },
                        {
                            "value": "c",
                            "text": "Zwang"
                        },
                        {
                            "value": "e",
                            "text": "Dissoziativ"
                        },
                        {
                            "value": "f",
                            "text": "Somatoform"
                        },
                        {
                            "value": "g",
                            "text": "Essen"
                        },
                        {
                            "value": "h",
                            "text": "Schlaf"
                        },
                        {
                            "value": "i",
                            "text": "Sexualit√§t"
                        },
                        {
                            "value": "j",
                            "text": "Andere"
                        }
                    ]
                }
            }
        }
    },
    methods: {},
    computed: {
        patient_secure() {
            // return data
            try {
                return this.$store.state.patient.data.extras.secure;
            } catch (e) {
                return "";
            };
        },
        sr_data() {
            // return data
            try {
                return this.$store.state.sr.data;
            } catch (e) {
                return [];
            };
        },
        sr_count_text() {
            // return data
            try {
                var ret_text = "";
                if (this.$store.state.sr.data.length === 0) {
                    ret_text = "Keine Erfassung";
                };
                if (this.$store.state.sr.data.length === 1) {
                    ret_text = "Eine Erfassung";
                };
                if (this.$store.state.sr.data.length > 1) {
                    ret_text = "Erfassungen (" + this.$store.state.sr.data.length + ")";
                };
                return ret_text;
            } catch (e) {
                return "";
            };
        },
        sr_full() {
            // return data
            try {
                return this.$store.state.sr;
            } catch (e) {
                return [];
            };
        },
        pdf_ready() {
            return false;
        }
    },
    template: `
        <div>
            <optinomic-content-block :subtitle="sr_count_text" title="Datentabelle" id="id_data_table">
                <optinomic-data-table :rows="data_table.rows" :interpretations="data_table.interpretations"></optinomic-data-table>
            </optinomic-content-block>
        </div>
    `
});

// Init Vue
new Vue({
    el: '#optinomic_app',
    vuetify: new Vuetify(),
    store: new Vuex.Store({
        state: {
            count: 0,
            apps: {},
            table_of_contents: [],
            current_app: null,
            sr: null,
            user: null,
            patient: null,
            clinic: null
        },
        mutations: {
            increment(state) {
                state.count++
            },
            saveData(state, d) {
                // console.error('state', d.root, d.data);
                state[d.root] = d.data;
                console.warn('state :: ', new Date(), state);
            }
        },
        actions: {
            getSurveyResponses({
                commit
            }) {
                var module_identifier = helpers.getAppID();
                var current_pid = parseInt(helpers.getPatientID());
                var current_stay_id = parseInt(helpers.getStayID());

                var base_data = {
                    "date": new Date(),
                    "data": null,
                    "calculations_all": null,
                    "have_data": false,
                    "possible_data": true,
                    "request": null,
                    "pid": current_pid,
                    "fid": current_stay_id,
                    "app_id": module_identifier
                };

                console.log('(?) getSurveyResponses', module_identifier, current_pid, current_stay_id);

                commit({
                    type: 'saveData',
                    root: 'sr',
                    data: base_data
                });

                var calculation_results_api_url = '/patients/' + current_pid + '/calculations/' + module_identifier;
                if (current_stay_id) {
                    var api_url = '/stays/' + current_stay_id + '/survey_responses/' + module_identifier + '/full';
                    data_request = 'stay';
                } else {
                    var api_url = '/patients/' + current_pid + '/survey_responses/' + module_identifier + '/full';
                    data_request = 'patient';
                };


                // Do async task
                helpers.callAPI('GET', api_url, {}, {}, function (req) {
                    
                    


                    var app_id = helpers.getAppID();

                    if (req.status == 200) {
                        var resp = JSON.parse(req.response);


                        helpers.callAPI('GET', calculation_results_api_url, {}, {}, function (inner_req) {

                            if (req.status == 200) {
                                var inner_resp = JSON.parse(inner_req.response);
                                var calculation_results = inner_resp.calculation_results;

                                // console.log('actionGetSurveyResponsesNew:: resp', resp, inner_resp);


                                // Reformat req
                                var return_array = [];
                                resp.survey_responses.forEach(function (current_response, srID) {
                                    var return_obj = {};

                                    return_obj.all_found = false;

                                    return_obj.app_id = null;
                                    return_obj.date = current_response.data.filled;

                                    return_obj.response_id = current_response.id;
                                    return_obj.response = current_response.data.response;

                                    return_obj.event = null;
                                    return_obj.event_found = false;
                                    return_obj.event_id = current_response.data.event_id;

                                    return_obj.patient = null;
                                    return_obj.patient_found = false;
                                    return_obj.patient_id = null;

                                    return_obj.stay = null;
                                    return_obj.stay_found = false;
                                    return_obj.stay_id = null;

                                    return_obj.patient_uses_module = null;
                                    return_obj.patient_uses_module_found = false;
                                    return_obj.patient_uses_module_id = null;

                                    return_obj.calculation = {};
                                    return_obj.calculation_found = false;
                                    return_obj.calculation_found_method = null;


                                    resp.events.forEach(function (current_event, eventID) {
                                        if (current_event.id === current_response.data.event_id) {
                                            return_obj.event_found = true;

                                            current_event.data.id = current_event.id;
                                            return_obj.event = current_event.data;
                                            return_obj.patient_uses_module_id = current_event.data.patient_uses_module_id;
                                            return_obj.patient_id = current_event.data.patient_id;
                                            return_obj.app_id = current_event.data.module;
                                            app_id = return_obj.app_id;
                                        };
                                    });


                                    if (return_obj.event_found) {
                                        resp.patients.forEach(function (current_patient, patientID) {
                                            if (current_patient.id === return_obj.patient_id) {
                                                return_obj.patient_found = true;
                                                current_patient.data.id = current_patient.id;
                                                current_patient.data.pid = current_patient.id;
                                                var current_patient_data = createPatientExtras(current_patient.data);
                                                return_obj.patient = current_patient_data;
                                            };
                                        });

                                        resp.patient_uses_modules.forEach(function (current_pum, pumID) {
                                            if (current_pum.id === return_obj.patient_uses_module_id) {
                                                return_obj.patient_uses_module_found = true;
                                                current_pum.data.id = current_pum.id;
                                                return_obj.patient_uses_module = current_pum.data;
                                                return_obj.stay_id = current_pum.data.stay_id;
                                            };
                                        });
                                    };

                                    if (return_obj.stay_id) {
                                        resp.stays.forEach(function (current_stay, stayID) {
                                            if (current_stay.id === return_obj.stay_id) {
                                                return_obj.stay_found = true;

                                                current_stay.data.id = current_stay.id;
                                                current_stay.data.fid = current_stay.id;
                                                var current_stay_data = createStayExtras(current_stay.data);
                                                return_obj.stay = current_stay_data;
                                            };
                                        });
                                    };

                                    // console.error('-> resp.calculations', resp.calculations);
                                    calculation_results.forEach(function (current_calculation_top, calculationID) {
                                        var calculation_name = current_calculation_top.name;


                                        if (current_calculation_top.result.length > 0) {
                                            current_calculation_top.result.forEach(function (current_calculation, calculationID) {
                                                var variant_info = false;
                                                if ("info" in current_calculation) {
                                                    if ("response" in current_calculation.info) {
                                                        variant_info = true;
                                                    };
                                                };

                                                var variant_response = false;
                                                if ("response" in current_calculation) {
                                                    if ("data" in current_calculation.response) {
                                                        if ("response" in current_calculation.response.data) {
                                                            variant_response = true;
                                                        };
                                                    };
                                                };

                                                if (variant_info) {
                                                    var calc_resp = current_calculation.info.response;

                                                    if (JSON.stringify(calc_resp) === JSON.stringify(return_obj.response)) {
                                                        // console.log('(+) EQUAL: ', calc_resp);

                                                        return_obj.calculation_found = true;
                                                        return_obj.calculation_found_method = "variant_info";
                                                        return_obj.calculation[calculation_name] = current_calculation;
                                                    };
                                                };

                                                if (variant_response) {
                                                    var calc_resp = current_calculation.response.data.response;

                                                    if (JSON.stringify(calc_resp) === JSON.stringify(return_obj.response)) {
                                                        // console.log('(+) EQUAL: ', calc_resp);

                                                        return_obj.calculation_found = true;
                                                        return_obj.calculation_found_method = "variant_response";
                                                        return_obj.calculation[calculation_name] = current_calculation;

                                                    } else {

                                                        if ("TMTAError" in calc_resp) {
                                                            // TMT - Special
                                                            // console.error('DEBUG HERE ::', calc_resp, return_obj.response, current_calculation);

                                                            if ((parseInt(calc_resp.TMTAError) === parseInt(return_obj.response.TMTAError)) &&
                                                                (parseInt(calc_resp.TMTATime) === parseInt(return_obj.response.TMTATime)) &&
                                                                (parseInt(calc_resp.TMTBError) === parseInt(return_obj.response.TMTBError)) &&
                                                                (parseInt(calc_resp.TMTBTime) === parseInt(return_obj.response.TMTBTime)) &&
                                                                (parseInt(calc_resp.Ausbildungsjahre) === parseInt(return_obj.response.Ausbildungsjahre)) &&
                                                                (parseInt(calc_resp.Messzeitpunkt) === parseInt(return_obj.response.Messzeitpunkt))
                                                            ) {

                                                                return_obj.calculation_found = true;
                                                                return_obj.calculation_found_method = "variant_response_tmt";
                                                                return_obj.calculation[calculation_name] = current_calculation;
                                                            };

                                                        };

                                                    };
                                                };
                                            });
                                        };
                                    });


                                    if (return_obj.calculation_found && return_obj.event_found && return_obj.patient_found && return_obj.stay_found && return_obj.patient_uses_module_found) {
                                        return_obj.all_found = true;
                                    };

                                    return_array.push(return_obj);
                                });


                                if (return_array.length > 0) {
                                    var have_data = true;

                                    // Sort
                                    return_array.sort(function (a, b) {
                                        var nameA = a.date.toUpperCase(); // ignore upper and lowercase
                                        var nameB = b.date.toUpperCase(); // ignore upper and lowercase
                                        if (nameA < nameB) {
                                            return -1;
                                        }
                                        if (nameA > nameB) {
                                            return 1;
                                        }
                                        return 0;
                                    });
                                } else {
                                    var have_data = false;
                                };

                                var response = {
                                    "date": new Date(),
                                    "data": return_array,
                                    "calculations_all": calculation_results,
                                    "have_data": have_data,
                                    "possible_data": true,
                                    "request": data_request,
                                    "pid": current_pid,
                                    "fid": current_stay_id,
                                    "app_id": app_id
                                };
                                console.log('(‚úî) Data (' + api_url + '):', response);


                                commit({
                                    type: 'saveData',
                                    root: 'sr',
                                    data: response
                                });


                            } else {
                                var response = {
                                    "error": true,
                                    "error_message": "Failed with status code: " + req.status,
                                    "status_code": req.status,
                                    "request": data_request,
                                    "app_id": app_id
                                };
                                console.error('(!) Error: ', response);
                            };
                        });

                    } else {
                        var response = {
                            "error": true,
                            "error_message": "Failed with status code: " + req.status,
                            "status_code": req.status,
                            "request": data_request,
                            "app_id": app_id
                        };
                        console.error('(!) Error: ', response);
                    };

                });


            },
            getApps({
                commit
            }) {

                var api_url = 'module_activations';
                var parameters = {}

                // Do async task
                helpers.callAPI('GET', api_url, parameters, {}, function (req) {
                    if (req.status == 200) {

                        var resp = JSON.parse(req.response);
                        var hotloaded = [];

                        // Sortieren nach App-Name
                        if ("patient_modules" in resp) {
                            if (resp.patient_modules.length > 0) {
                                resp.patient_modules.sort(function (a, b) {
                                    var nameA = a.module.name.toUpperCase(); // ignore upper and lowercase
                                    var nameB = b.module.name.toUpperCase(); // ignore upper and lowercase
                                    if (nameA < nameB) {
                                        return -1;
                                    }
                                    if (nameA > nameB) {
                                        return 1;
                                    }
                                    return 0;
                                });

                                resp.patient_modules.forEach(function (m, mID) {
                                    m.first_template = {
                                        "found": "false",
                                        "name": null
                                    };

                                    // Safty - not breakting thins
                                    m.identifier = m.module.identifier;

                                    if (m.module.templates.length > 0) {
                                        m.first_template.name = m.module.templates["0"].name;
                                        m.first_template.found = true;
                                    };

                                    if (m.module_activation.data.overwritten) {
                                        hotloaded.push(m);
                                    };

                                    if (m.identifier === helpers.getAppID()) {
                                        commit({
                                            type: 'saveData',
                                            root: 'current_app',
                                            data: m
                                        });
                                    };

                                });

                            };
                        };
                        if ("user_modules" in resp) {

                            if (resp.user_modules.length > 0) {
                                resp.user_modules.sort(function (a, b) {
                                    var nameA = a.module.name.toUpperCase(); // ignore upper and lowercase
                                    var nameB = b.module.name.toUpperCase(); // ignore upper and lowercase
                                    if (nameA < nameB) {
                                        return -1;
                                    }
                                    if (nameA > nameB) {
                                        return 1;
                                    }
                                    return 0;
                                });

                                resp.user_modules.forEach(function (m, mID) {
                                    m.first_template = {
                                        "found": "false",
                                        "name": null
                                    };

                                    // Safty - not breakting thins
                                    m.identifier = m.module.identifier;

                                    if (m.module.templates.length > 0) {
                                        m.first_template.name = m.module.templates["0"].name;
                                        m.first_template.found = true;
                                    };

                                    if (m.module_activation.data.overwritten) {
                                        hotloaded.push(m);
                                    };

                                    if (m.identifier === helpers.getAppID()) {
                                        commit({
                                            type: 'saveData',
                                            root: 'current_app',
                                            data: m
                                        });
                                    };

                                });
                            };
                        };

                        var response = {
                            "data": {
                                "patient_modules": resp.patient_modules,
                                "user_modules": resp.user_modules,
                                "errors": resp.errors,
                                "hotloaded": hotloaded
                            }
                        };

                        response = addOptinomicExtras(response, api_url);


                        commit({
                            type: 'saveData',
                            root: 'apps',
                            data: response
                        });


                        console.log('(‚úî) Data (' + api_url + '):', response, parameters);
                    } else {
                        // Errorhandling
                        // While what action with what params error happend
                        var error_action = {
                            "name": "getApps",
                            "params": []
                        };

                        dispatch({
                            "type": "ERROR",
                            "error": handleError(req, error_action)
                        });
                    };

                });

            },
            getUser({
                commit
            }) {

                const api_url = '/users/' + helpers.getUserID();
                var parameters = {}

                // Do async task
                helpers.callAPI('GET', api_url, parameters, {}, function (req) {
                    if (req.status == 200) {

                        var resp = JSON.parse(req.response);
                        var data_return = resp.user.data;
                        data_return.id = resp.user.id;
                        data_return.uid = resp.user.id;
                        data_return.isAdmin = false;
                        if (resp.user.data.role === "Admin") {
                            data_return.isAdmin = true;
                        };

                        var response = {
                            "id": resp.user.id,
                            "date": new Date(),
                            "data": data_return
                        };
                        console.log('(‚úî) Data (' + api_url + '):', response);

                        commit({
                            type: 'saveData',
                            root: 'user',
                            data: response
                        });

                    } else {
                        var response = {
                            "error": true,
                            "api_url": api_url,
                            "error_message": "Failed with status code: " + req.status,
                            "status_code": req.status,
                            "req": req
                        };
                        console.error('(!) Error: ', response);
                    };

                });

            },
            getPatient({
                commit
            }) {

                const api_url = '/patients/' + helpers.getPatientID();
                var parameters = {}

                // Do async task
                helpers.callAPI('GET', api_url, parameters, {}, function (req) {
                    if (req.status == 200) {

                        var resp = JSON.parse(req.response);
                        var data_return = resp.patient.data;
                        data_return.id = resp.patient.id;
                        data_return.pid = resp.patient.id;
                        data_return.extras = createPatientExtras(data_return);

                        var response = {
                            "date": new Date(),
                            "data": data_return
                        };
                        console.log('(‚úî) Data (' + api_url + '):', response);

                        commit({
                            type: 'saveData',
                            root: 'patient',
                            data: response
                        });

                    } else {
                        var response = {
                            "error": true,
                            "api_url": api_url,
                            "error_message": "Failed with status code: " + req.status,
                            "status_code": req.status,
                            "req": req
                        };
                        console.error('(!) Error: ', response);
                    };

                });

            },
            getClinic({
                commit
            }) {

                const api_url = '/clinic';
                var parameters = {}

                // Do async task
                helpers.callAPI('GET', api_url, parameters, {}, function (req) {
                    if (req.status == 200) {

                        var resp = JSON.parse(req.response);

                        // All fields are coming as array: Make Object out of it:
                        var json_data = {};
                        resp.clinic.forEach(function (item, itemIndex) {
                            json_data[item[0]] = item[1];
                        });

                        var response = {
                            "date": new Date(),
                            "data": json_data
                        };
                        response.data.array = resp.clinic;
                        console.log('(‚úî) Data (' + api_url + '):', response);

                        commit({
                            type: 'saveData',
                            root: 'clinic',
                            data: response
                        });

                    } else {
                        var response = {
                            "error": true,
                            "api_url": api_url,
                            "error_message": "Failed with status code: " + req.status,
                            "status_code": req.status,
                            "req": req
                        };
                        console.error('(!) Error: ', response);
                    };

                });

            },
            myincrement({
                commit
            }) {

                var api_url = 'clinic';

                axios
                    .get(helpers.getApiURL() + "clinic")
                    .then(response => {
                        console.log('RESP', response);
                        commit('saveClinic', response);
                        commit('increment');
                    })
                    .catch(error => console.log('Error: ' + api_url + ': ', error))
            }
        }
    }),
    methods: {}
});

</script>




[readme]
## HoNOS (Health of the Nations Outcome Scale)

### Zusammenfassung

Fremdeinsch√§tzung von Gesundheit und sozialer Funktionsf√§higkeit mittels 12 Items durch eine therapeutische Fachperson.

### Administrator

#### Schnittstelle

Die Schnittstelle wurde am 1. Juni 2019 auf `Navision` angepasst. Das Ausgabeverzeichnis lautet `/media/hl7_files/PROD/FROM_OPTINOMIC/`.

#### Komplettexport

In der SQL-Toolbox kann die [navision_interface.sql](https://github.com/Optinomic/ch.suedhang.apps.honos.production/blob/master/includes/navision_interface.sql#L105) Abfrage ausgef√ºhrt werden. Lediglich [diese Zeile](https://github.com/Optinomic/ch.suedhang.apps.honos.production/blob/master/includes/navision_interface.sql#L105) gilt es auszuklammern, da wir nicht nur Exporte vom aktuellen Tag exportieren wollen.  

F√ºr den CSV-Export muss die Abfrage mit folgenden Parametern ausgegeben werden:    
`{ direct: "True", format: "csv", delimiter: ",", crlf: "True" }`


[dependencies]

[javascript]





[survey]
id = HoNOS
type = lime
responsibility = Admin
name = HoNOS
host = default
survey_id = 927351
hash = X24X325
pid = X24X326
fid = X24X327
min_questions =
min_lastpage = 2

[event activation]
type = on_activation
due_after = 259200
overdue = send_reminder_once
description = HoNOS Eintritt
survey = HoNOS

[event before_exit]
type = before_exit
days = 3
time = 00:00
due_after = 259200
overdue = send_reminder_once
description = HoNOS Austritt
survey = HoNOS


[email new_event html]
<!DOCTYPE html>
<html lang="de">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Optinomic :: $patient_secure$</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style type="text/css">
    #ko_onecolumnBlock_3 .textintenseStyle a,
    #ko_onecolumnBlock_3 .textintenseStyle a:link,
    #ko_onecolumnBlock_3 .textintenseStyle a:visited,
    #ko_onecolumnBlock_3 .textintenseStyle a:hover {
        color: #fff;
        color: ;
        text-decoration: none;
        text-decoration: none;
        font-weight: bold;
    }
    
    #ko_onecolumnBlock_3 .textlightStyle a,
    #ko_onecolumnBlock_3 .textlightStyle a:link,
    #ko_onecolumnBlock_3 .textlightStyle a:visited,
    #ko_onecolumnBlock_3 .textlightStyle a:hover {
        color: #3f3d33;
        color: ;
        text-decoration: none;
        text-decoration: ;
        font-weight: bold;
    }
    </style>
    <style type="text/css">
    /* CLIENT-SPECIFIC STYLES */
    
    #outlook a {
        padding: 0;
    }
    /* Force Outlook to provide a "view in browser" message */
    
    .ReadMsgBody {
        width: 100%;
    }
    
    .ExternalClass {
        width: 100%;
    }
    /* Force Hotmail to display emails at full width */
    
    .ExternalClass,
    .ExternalClass p,
    .ExternalClass span,
    .ExternalClass font,
    .ExternalClass td,
    .ExternalClass div {
        line-height: 100%;
    }
    /* Force Hotmail to display normal line spacing */
    
    body,
    table,
    td,
    a {
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
    }
    /* Prevent WebKit and Windows mobile changing default text sizes */
    
    table,
    td {
        mso-table-lspace: 0pt;
        mso-table-rspace: 0pt;
    }
    /* Remove spacing between tables in Outlook 2007 and up */
    
    img {
        -ms-interpolation-mode: bicubic;
    }
    /* Allow smoother rendering of resized image in Internet Explorer */
    /* RESET STYLES */
    
    body {
        margin: 0;
        padding: 0;
    }
    
    img {
        border: 0;
        height: auto;
        line-height: 100%;
        outline: none;
        text-decoration: none;
    }
    
    table {
        border-collapse: collapse !important;
    }
    
    body {
        height: 100% !important;
        margin: 0;
        padding: 0;
        width: 100% !important;
    }
    /* iOS BLUE LINKS */
    
    .appleBody a {
        color: #68440a;
        text-decoration: none;
    }
    
    .appleFooter a {
        color: #999999;
        text-decoration: none;
    }
    /* MOBILE STYLES */
    
    @media screen and (max-width: 525px) {
        /* ALLOWS FOR FLUID TABLES */
        table[class="wrapper"] {
            width: 100% !important;
            min-width: 0px !important;
        }
        /* USE THESE CLASSES TO HIDE CONTENT ON MOBILE */
        td[class="mobile-hide"] {
            display: none;
        }
        img[class="mobile-hide"] {
            display: none !important;
        }
        img[class="img-max"] {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
        }
        /* FULL-WIDTH TABLES */
        table[class="responsive-table"] {
            width: 100%!important;
        }
        /* UTILITY CLASSES FOR ADJUSTING PADDING ON MOBILE */
        td[class="padding"] {
            padding: 10px 5% 15px 5% !important;
        }
        td[class="padding-copy"] {
            padding: 10px 5% 10px 5% !important;
            text-align: center;
        }
        td[class="padding-meta"] {
            padding: 30px 5% 0px 5% !important;
            text-align: center;
        }
        td[class="no-pad"] {
            padding: 0 0 0px 0 !important;
        }
        td[class="no-padding"] {
            padding: 0 !important;
        }
        td[class="section-padding"] {
            padding: 10px 15px 10px 15px !important;
        }
        td[class="section-padding-bottom-image"] {
            padding: 10px 15px 0 15px !important;
        }
        /* ADJUST BUTTONS ON MOBILE */
        td[class="mobile-wrapper"] {
            padding: 10px 5% 15px 5% !important;
        }
        table[class="mobile-button-container"] {
            margin: 0 auto;
            width: 100% !important;
        }
        a[class="mobile-button"] {
            width: 80% !important;
            padding: 15px !important;
            border: 0 !important;
            font-size: 16px !important;
        }
    }
    </style>
</head>


<body style="margin: 0; padding: 0;" bgcolor="#ffffff" align="center">
    <!-- PREHEADER -->
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="min-width: 530px;" id="ko_preheaderBlock_1">
    <tbody>
        <tr>
            <td bgcolor="#3F3D33" class="mobile-hide">
                <div align="center" style="padding: 0px 15px 0px 15px;">
                    <table border="0" cellpadding="0" cellspacing="0" width="500" style="min-width: 500px;" class="wrapper">
                        <!--Preheade/view on web TEXT -->
                        <tbody>
                            <tr>
                                <td style="padding: 10px 0px 10px 0px;">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tbody>
                                            <tr>
                                                <td bgcolor="#3F3D33" width="50%" align="left" class="mobile-hide">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tbody>
                                                            <tr>
                                                                <td align="left" style="padding: 0 0 5px 0; font-size: 12px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none;">$clinic_clinic_name$
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                                <td bgcolor="#3F3D33" width="50%" align="right" class="mobile-hide">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tbody>
                                                            <tr>
                                                                <td align="right" style="padding: 0 0 5px 0; font-size: 10px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none;">$clinic_clinic_slogan$
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
    </tbody>
</table>

    <table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_onecolumnBlock_3">
        <tbody>
            <tr class="row-a">
                <td bgcolor="#FFFFFF" align="center" class="section-padding" style="padding-top: 30px; padding-left: 15px; padding-bottom: 30px; padding-right: 15px;">
                    <table border="0" cellpadding="0" cellspacing="0" width="500" class="responsive-table">
                        <tbody>
                            <tr>
                                <td>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td>
                <!-- CONTENT | Beschreibung der Applikation -->
                <table width="100%" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td align="center" class="padding-copy" style="font-size: 25px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33; padding-top: 0px; margin-top: 48px;">
                                <br>$recipient_name$
                            </td>
                        </tr>
                        <tr>
                            <td align="center" class="padding-copy textlightStyle" style="padding: 20px 0 0 0; font-size: 16px; line-height: 25px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33;">
                                <p style="margin:0px;" data-mce-style="margin: 0px;">
                                    <strong>HoNOS (Health of the Nations Outcome Scale):</strong>¬† Der HoNOS f√ºr $patient$ sollte innerhalb der n√§chsten 3 Tage ausgef√ºllt werden.
                                </p>
                                <p style="margin:0px;" data-mce-style="margin: 0px;">
                                    <br data-mce-bogus="1">
                                </p>
                                <p style="margin:0px; font-size: 12px; color: rgb(40, 53, 147);" data-mce-style="margin: 0px;">
                                    Besten Dank und liebe Gr√ºsse,
                                    <br><span style="color: rgb(197,202,233);" data-mce-style="color: #C5CAE9;">
                                    Team Ergebnisqualit√§t</span>
                                    <br>
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td>
                <!-- Survey - Link | BUTTON -->
                <table width="100%" border="0" cellspacing="0" cellpadding="0" class="mobile-button-container">
                    <tbody>
                        <tr>
                            <td align="center" style="padding: 25px 0 0 0;" class="padding-copy">
                                <table border="0" cellspacing="0" cellpadding="0" class="responsive-table">
                                    <tbody>
                                        <tr>
                                            <td align="center">
                                                <a href="$survey_link$" class="mobile-button" style="display: inline-block; font-size: 18px; font-family: Helvetica, Arial, sans-serif; font-weight: normal; color: #ffffff; text-decoration: none; background-color: #283593; padding-top: 15px; padding-bottom: 15px; padding-left: 25px; padding-right: 25px; border-radius: 3px; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-bottom: 3px solid #1b2463;">
                                                    HoNOS | Jetzt ausf√ºllen
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>
</td></tr></tbody></table></td></tr></tbody></table>
<!-- Absender -->
<div style="margin-top:24px;">&nbsp;</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_footerBlock_2" style="border-top: thin solid #BDBDBD;">
    <tbody>
        <tr>
            <td bgcolor="#EEEEEE" align="center">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                    <tbody>
                        <tr>
                            <td style="padding: 20px 0px 20px 0px;">
                                <!-- UNSUBSCRIBE COPY -->
                                <table width="500" border="0" cellspacing="0" cellpadding="0" align="center" class="responsive-table">
                                    <tbody>
                                        <tr style="text-align: center;">
                                            <td>
                                                <a href="$clinic_clinic_www$"><img border="0" hspace="0" vspace="0" src="$clinic_clinic_logo$" alt="$clinic_clinic_name$" style="margin-top: 24px; width: 150px;"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center" class="padding-copy textlightStyle" style="padding: 20px 0 0 0; font-size: 12px; line-height: 21px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33; text-decoration: none;" data-mce-style="margin: 0px;">
                                                <p>$clinic_clinic_name$
                                                    <br> $clinic_clinic_slogan$
                                                    <br> $clinic_clinic_address$
                                                    <br> $clinic_clinic_phone$, $clinic_clinic_email$
                                                </p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>

<!-- FOOTER -->
<table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_footerBlock_2" style="border-top: thin solid #7986CB;border-bottom: thin solid #7986CB;">
    <tbody>
        <tr>
            <td bgcolor="#E8EAF6" align="center">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                    <tbody>
                        <tr>
                            <td style="padding: 20px 0px 20px 0px;">
                                <!-- UNSUBSCRIBE COPY -->
                                <table width="500" border="0" cellspacing="0" cellpadding="0" align="center" class="responsive-table">
                                    <tbody>
                                        <tr style="text-align: center;">
                                            <td>
                                                <a href="http://www.optinomic.com/"><img border="0" hspace="0" vspace="0" src="http://www.optinomic.com/_download/logo/optinomic_logo_trademark_indigo.png" alt="Optinomic" style="margin-top: 24px; width: 15%;"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center" valign="middle" style="font-size: 12px; line-height: 18px; font-family: Helvetica, Arial, sans-serif; color: #3F51B5;margin-top: 24px;">
                                                <br>
                                                <a class="original-only" href="http://www.optinomic.com/" style="color: #3F51B5; text-decoration: none;">Optinomic GmbH
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>

</body>
</html>



[email overdue html]
<!DOCTYPE html>
<html lang="de">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Optinomic :: $patient_secure$</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style type="text/css">
    #ko_onecolumnBlock_3 .textintenseStyle a,
    #ko_onecolumnBlock_3 .textintenseStyle a:link,
    #ko_onecolumnBlock_3 .textintenseStyle a:visited,
    #ko_onecolumnBlock_3 .textintenseStyle a:hover {
        color: #fff;
        color: ;
        text-decoration: none;
        text-decoration: none;
        font-weight: bold;
    }
    
    #ko_onecolumnBlock_3 .textlightStyle a,
    #ko_onecolumnBlock_3 .textlightStyle a:link,
    #ko_onecolumnBlock_3 .textlightStyle a:visited,
    #ko_onecolumnBlock_3 .textlightStyle a:hover {
        color: #3f3d33;
        color: ;
        text-decoration: none;
        text-decoration: ;
        font-weight: bold;
    }
    </style>
    <style type="text/css">
    /* CLIENT-SPECIFIC STYLES */
    
    #outlook a {
        padding: 0;
    }
    /* Force Outlook to provide a "view in browser" message */
    
    .ReadMsgBody {
        width: 100%;
    }
    
    .ExternalClass {
        width: 100%;
    }
    /* Force Hotmail to display emails at full width */
    
    .ExternalClass,
    .ExternalClass p,
    .ExternalClass span,
    .ExternalClass font,
    .ExternalClass td,
    .ExternalClass div {
        line-height: 100%;
    }
    /* Force Hotmail to display normal line spacing */
    
    body,
    table,
    td,
    a {
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
    }
    /* Prevent WebKit and Windows mobile changing default text sizes */
    
    table,
    td {
        mso-table-lspace: 0pt;
        mso-table-rspace: 0pt;
    }
    /* Remove spacing between tables in Outlook 2007 and up */
    
    img {
        -ms-interpolation-mode: bicubic;
    }
    /* Allow smoother rendering of resized image in Internet Explorer */
    /* RESET STYLES */
    
    body {
        margin: 0;
        padding: 0;
    }
    
    img {
        border: 0;
        height: auto;
        line-height: 100%;
        outline: none;
        text-decoration: none;
    }
    
    table {
        border-collapse: collapse !important;
    }
    
    body {
        height: 100% !important;
        margin: 0;
        padding: 0;
        width: 100% !important;
    }
    /* iOS BLUE LINKS */
    
    .appleBody a {
        color: #68440a;
        text-decoration: none;
    }
    
    .appleFooter a {
        color: #999999;
        text-decoration: none;
    }
    /* MOBILE STYLES */
    
    @media screen and (max-width: 525px) {
        /* ALLOWS FOR FLUID TABLES */
        table[class="wrapper"] {
            width: 100% !important;
            min-width: 0px !important;
        }
        /* USE THESE CLASSES TO HIDE CONTENT ON MOBILE */
        td[class="mobile-hide"] {
            display: none;
        }
        img[class="mobile-hide"] {
            display: none !important;
        }
        img[class="img-max"] {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
        }
        /* FULL-WIDTH TABLES */
        table[class="responsive-table"] {
            width: 100%!important;
        }
        /* UTILITY CLASSES FOR ADJUSTING PADDING ON MOBILE */
        td[class="padding"] {
            padding: 10px 5% 15px 5% !important;
        }
        td[class="padding-copy"] {
            padding: 10px 5% 10px 5% !important;
            text-align: center;
        }
        td[class="padding-meta"] {
            padding: 30px 5% 0px 5% !important;
            text-align: center;
        }
        td[class="no-pad"] {
            padding: 0 0 0px 0 !important;
        }
        td[class="no-padding"] {
            padding: 0 !important;
        }
        td[class="section-padding"] {
            padding: 10px 15px 10px 15px !important;
        }
        td[class="section-padding-bottom-image"] {
            padding: 10px 15px 0 15px !important;
        }
        /* ADJUST BUTTONS ON MOBILE */
        td[class="mobile-wrapper"] {
            padding: 10px 5% 15px 5% !important;
        }
        table[class="mobile-button-container"] {
            margin: 0 auto;
            width: 100% !important;
        }
        a[class="mobile-button"] {
            width: 80% !important;
            padding: 15px !important;
            border: 0 !important;
            font-size: 16px !important;
        }
    }
    </style>
</head>


<body style="margin: 0; padding: 0;" bgcolor="#ffffff" align="center">
    <!-- PREHEADER -->
<table border="0" cellpadding="0" cellspacing="0" width="100%" style="min-width: 530px;" id="ko_preheaderBlock_1">
    <tbody>
        <tr>
            <td bgcolor="#3F3D33" class="mobile-hide">
                <div align="center" style="padding: 0px 15px 0px 15px;">
                    <table border="0" cellpadding="0" cellspacing="0" width="500" style="min-width: 500px;" class="wrapper">
                        <!--Preheade/view on web TEXT -->
                        <tbody>
                            <tr>
                                <td style="padding: 10px 0px 10px 0px;">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tbody>
                                            <tr>
                                                <td bgcolor="#3F3D33" width="50%" align="left" class="mobile-hide">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tbody>
                                                            <tr>
                                                                <td align="left" style="padding: 0 0 5px 0; font-size: 12px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none;">$clinic_clinic_name$
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                                <td bgcolor="#3F3D33" width="50%" align="right" class="mobile-hide">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tbody>
                                                            <tr>
                                                                <td align="right" style="padding: 0 0 5px 0; font-size: 10px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none;">$clinic_clinic_slogan$
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
    </tbody>
</table>

    <table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_onecolumnBlock_3">
        <tbody>
            <tr class="row-a">
                <td bgcolor="#FFFFFF" align="center" class="section-padding" style="padding-top: 30px; padding-left: 15px; padding-bottom: 30px; padding-right: 15px;">
                    <table border="0" cellpadding="0" cellspacing="0" width="500" class="responsive-table">
                        <tbody>
                            <tr>
                                <td>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td>
                <!-- CONTENT | Beschreibung der Applikation -->
                <table width="100%" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td align="center" class="padding-copy" style="font-size: 25px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33; padding-top: 0px; margin-top: 48px;">
                                <br>$recipient_name$
                            </td>
                        </tr>
                        <tr>
                            <td align="center" class="padding-copy textlightStyle" style="padding: 20px 0 0 0; font-size: 16px; line-height: 25px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33;">
                                <p style="margin:0px;" data-mce-style="margin: 0px;">
                                    <strong>HoNOS-Erinnerung:</strong>¬† Der HoNOS-Fragebogen f√ºr $patient$ wurde noch nicht ausgef√ºllt. Bitte sobald wie m√∂glich nachholen und wenn n√∂tig r√ºckdatieren.
                                </p>
                                <p style="margin:0px;" data-mce-style="margin: 0px;">
                                    <br data-mce-bogus="1">
                                </p>
                                <p style="margin:0px; font-size: 12px; color: rgb(40, 53, 147);" data-mce-style="margin: 0px;">
                                    Besten Dank und liebe Gr√ºsse,
                                    <br><span style="color: rgb(197,202,233);" data-mce-style="color: #C5CAE9;">
                                    Team Ergebnisqualit√§t</span>
                                    <br>
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td>
                <!-- Survey - Link | BUTTON -->
                <table width="100%" border="0" cellspacing="0" cellpadding="0" class="mobile-button-container">
                    <tbody>
                        <tr>
                            <td align="center" style="padding: 25px 0 0 0;" class="padding-copy">
                                <table border="0" cellspacing="0" cellpadding="0" class="responsive-table">
                                    <tbody>
                                        <tr>
                                            <td align="center">
                                                <a href="$survey_link$" class="mobile-button" style="display: inline-block; font-size: 18px; font-family: Helvetica, Arial, sans-serif; font-weight: normal; color: #ffffff; text-decoration: none; background-color: #283593; padding-top: 15px; padding-bottom: 15px; padding-left: 25px; padding-right: 25px; border-radius: 3px; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-bottom: 3px solid #1b2463;">
                                                    HoNOS | Jetzt ausf√ºllen
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>
</td></tr></tbody></table></td></tr></tbody></table>
<!-- Absender -->
<div style="margin-top:24px;">&nbsp;</div>
<table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_footerBlock_2" style="border-top: thin solid #BDBDBD;">
    <tbody>
        <tr>
            <td bgcolor="#EEEEEE" align="center">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                    <tbody>
                        <tr>
                            <td style="padding: 20px 0px 20px 0px;">
                                <!-- UNSUBSCRIBE COPY -->
                                <table width="500" border="0" cellspacing="0" cellpadding="0" align="center" class="responsive-table">
                                    <tbody>
                                        <tr style="text-align: center;">
                                            <td>
                                                <a href="$clinic_clinic_www$"><img border="0" hspace="0" vspace="0" src="$clinic_clinic_logo$" alt="$clinic_clinic_name$" style="margin-top: 24px; width: 150px;"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center" class="padding-copy textlightStyle" style="padding: 20px 0 0 0; font-size: 12px; line-height: 21px; font-family: Helvetica, Arial, sans-serif; color: #3F3D33; text-decoration: none;" data-mce-style="margin: 0px;">
                                                <p>$clinic_clinic_name$
                                                    <br> $clinic_clinic_slogan$
                                                    <br> $clinic_clinic_address$
                                                    <br> $clinic_clinic_phone$, $clinic_clinic_email$
                                                </p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>

<!-- FOOTER -->
<table border="0" cellpadding="0" cellspacing="0" width="100%" id="ko_footerBlock_2" style="border-top: thin solid #7986CB;border-bottom: thin solid #7986CB;">
    <tbody>
        <tr>
            <td bgcolor="#E8EAF6" align="center">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                    <tbody>
                        <tr>
                            <td style="padding: 20px 0px 20px 0px;">
                                <!-- UNSUBSCRIBE COPY -->
                                <table width="500" border="0" cellspacing="0" cellpadding="0" align="center" class="responsive-table">
                                    <tbody>
                                        <tr style="text-align: center;">
                                            <td>
                                                <a href="http://www.optinomic.com/"><img border="0" hspace="0" vspace="0" src="http://www.optinomic.com/_download/logo/optinomic_logo_trademark_indigo.png" alt="Optinomic" style="margin-top: 24px; width: 15%;"></a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td align="center" valign="middle" style="font-size: 12px; line-height: 18px; font-family: Helvetica, Arial, sans-serif; color: #3F51B5;margin-top: 24px;">
                                                <br>
                                                <a class="original-only" href="http://www.optinomic.com/" style="color: #3F51B5; text-decoration: none;">Optinomic GmbH
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>

</body>
</html>




[sql_init]
CREATE OR REPLACE VIEW honos_view AS


SELECT

-- START:  Optinoimc Default |  Needed for Export-Toolbox
  survey_response_view.patient_id as optinomic_patient_id,
  survey_response_view.stay_id as optinomic_stay_id,
  survey_response_view.event_id as optinomic_event_id,
  survey_response_view.survey_response_id as optinomic_survey_response_id,
  survey_response_view.filled as optinomic_survey_filled,
  ((cast(response AS json))->>'id') as optinomic_limesurvey_id,
  -- END:  Optinoimc Default |  Needed for Export-Toolbox
  stay.cis_fid as cis_fid,
  stay.cis_fid/100 as FID,
  patient,
  survey_response_view.survey_response_id AS survey_response_id,
  ((cast(response AS json))->>'PID') as PID_Limesurvey,
  'PH' as Rekordart,
  71286515 as betriebsnummer_bur,
  ((cast(response AS json))->>'FID') as FID_survey,
  ((cast(response AS json))->>'q401V04') as zeitpunkt_honos,
  ((cast(response AS json))->>'q401V05') as dropoutcode_honos,
  ((cast(response AS json))->>'q401V06') as spezifikation_dropout_honos_andere,
  TO_CHAR(TO_DATE(((cast(response AS json))->>'q402V00'), 'YYYY-MM-DD'), 'YYYYMMDD') as datum_erhebung_honos,
  ((cast(response AS json))->>'H1[402V01]') as honos_h1,
  ((cast(response AS json))->>'H1[402V02]') as honos_h2,
  ((cast(response AS json))->>'H1[402V03]') as honos_h3,
  ((cast(response AS json))->>'H1[402V04]') as honos_h4,
  ((cast(response AS json))->>'H1[402V05]') as honos_h5,
  ((cast(response AS json))->>'H1[402V06]') as honos_h6,
  ((cast(response AS json))->>'H1[402V07]') as honos_h7,
  ((cast(response AS json))->>'H1[402V08]') as honos_h8,
  ((cast(response AS json))->>'q402V09') as honos_h8a,
  ((cast(response AS json))->>'q402V10') as honos_h8b,  
  ((cast(response AS json))->>'H2[402V11]') as honos_h9,
  ((cast(response AS json))->>'H2[402V12]') as honos_h10,
  ((cast(response AS json))->>'H2[402V13]') as honos_h11,
  ((cast(response AS json))->>'H2[402V14]') as honos_h12
FROM "survey_response_view" 
LEFT JOIN patient ON(survey_response_view.patient_id = patient.id) 
LEFT JOIN stay ON(survey_response_view.stay_id = stay.id)
WHERE module = 'ch.suedhang.apps.honos' 
AND ((cast(response AS json))->>'q401V04') != '';


[calculation honos_calculation javascript]
function main(responses) {
    var calc = {};

    // ------------------------------------------
    // H e l p e r   -   F U N C T I O N S
    // ------------------------------------------


    calc.roundToOne = function(num) {
        return +(Math.round(num + "e+1") + "e-1");
    };

    calc.getType = function(my_value) {

        my_value = parseInt(my_value);

        var type = {
            name: 'Verlauf',
            id: my_value
        };

        if (my_value === 1) {
            type.name = 'Eintritt';
        };

        if (my_value === 2) {
            type.name = 'Austritt';
        };

        return type;
    };

    calc.getDropout = function(my_value, my_raeson) {

        my_value = parseInt(my_value);

        var obj = {
            dropout: false,
            dropout_raeson: '',
            dropout_id: my_value
        };

        if (my_value === 1) {
            obj.dropout = true;
            obj.dropout_raeson = 'Patient ist innerhalb von 7 Tagen nach Eintritt ausgetreten.';
        };

        if (my_value === 2) {
            obj.dropout = true;
            obj.dropout_raeson = my_raeson;
        };

        return obj;
    };



    // ------------------------------------------
    // F U N C T I O N  -  Main
    // ------------------------------------------
    calc.getResults = function(myResponses) {

        var responses_array = myResponses.survey_responses;
        var allResults = [];

        responses_array.forEach(function(response, myindex) {
            var d = {};
            var r = response.data.response;

            // --------------------------
            // Calculations
            // --------------------------
            d.type = calc.getType(r['q401V04']);
            d.dropout = calc.getDropout(r['q401V05'], r['q401V06']);


            var scores = [{
                "var": "H1[402V01]",
                "sum_score": 0
            }, {
                "var": "H1[402V02]",
                "sum_score": 0
            }, {
                "var": "H1[402V03]",
                "sum_score": 0
            }, {
                "var": "H1[402V04]",
                "sum_score": 0
            }, {
                "var": "H1[402V05]",
                "sum_score": 0
            }, {
                "var": "H1[402V06]",
                "sum_score": 0
            }, {
                "var": "H1[402V07]",
                "sum_score": 0
            }, {
                "var": "H1[402V08]",
                "sum_score": 0
            }, {
                "var": "H2[402V11]",
                "sum_score": 0
            }, {
                "var": "H2[402V12]",
                "sum_score": 0
            }, {
                "var": "H2[402V13]",
                "sum_score": 0
            }, {
                "var": "H2[402V14]",
                "sum_score": 0
            }];


            var sum_obj = {
                "count_kA": 0,
                "count_value": 0,
                "sum_score": 0,
                "sum_total": 0
            };


            for (var x = 0; x < scores.length; x++) {
                var current_score = scores[x];
                var current_value = parseInt(r[current_score.var]);

                if (current_value === 9) {
                    current_score.sum_score = 'k.A.';
                    sum_obj.count_kA = sum_obj.count_kA + 1;
                } else {
                    sum_obj.sum_total = sum_obj.sum_total + current_value;
                    sum_obj.count_value = sum_obj.count_value + 1;

                    current_score.sum_score = current_value;
                };
            };


            if (sum_obj.count_value === 0) {
                sum_obj.sum_score = 'k.A.';
            } else {

                sum_obj.sum_score = sum_obj.sum_total / sum_obj.count_value * 12;
                sum_obj.sum_score_rounded = calc.roundToOne(sum_obj.sum_score);
            }

            d.scores = scores;
            d.sum_score = sum_obj;

            // Write Results for the Return
            // Do not modify stuff here
            d.hash = r['optinomixHASH'];
            d.response = response;
            allResults.push(d);
        });

        return allResults;
    };


    // Return
    return calc.getResults(responses);
}

